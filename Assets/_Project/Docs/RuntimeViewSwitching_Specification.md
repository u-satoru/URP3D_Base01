# ランタイム視点切り替え機能 - システム仕様書

## 文書情報

| 項目 | 詳細 |
|------|------|
| **文書名** | ランタイム視点切り替え機能システム仕様書 |
| **プロジェクト** | URP3D_Base01 |
| **作成日** | 2025年9月7日 |
| **版数** | v1.0 |
| **ステータス** | 仕様確定 |
| **対象読者** | 開発チーム、QAチーム、ゲームデザイナー |

---

## 1. 概要

### 1.1 目的

現在実装されているカメラシステムに、**ゲームプレイ中にリアルタイムで一人称視点（FPS）と三人称視点（TPS）を切り替えられる機能**を追加する。プレイヤーの好みやゲーム状況に応じて最適な視点でプレイできる環境を提供し、ゲーム体験の向上を図る。

### 1.2 背景

#### 現状分析
- 既存システム：`ViewModeController`による視点管理実装済み
- 状態管理：`CameraStateMachine`によるステート制御実装済み  
- Cinemachine統合：`CinemachineIntegration`による高度制御実装済み
- 設定システム：各視点別設定（`FirstPersonSettings`, `ThirdPersonSettings`）実装済み

#### 追加の必要性
- **プレイヤー選択の自由度向上**：状況に応じた視点選択
- **アクセシビリティ向上**：酔いやすいプレイヤーへの配慮
- **戦術的ゲームプレイ**：精密射撃（FPS）と状況把握（TPS）の使い分け
- **現代ゲーム標準機能**：多くのAAAタイトルで採用されている機能

### 1.3 スコープ

#### 機能範囲
- ゲームプレイ中のFPS/TPS即座切り替え
- 入力システム統合（キーボード・コントローラー対応）
- UI表示の動的切り替え（HUD、クロスヘア等）
- 設定保存・復元機能
- 既存システムとの完全統合

#### 非機能範囲
- 新しい視点モードの追加（Cover視点等は既存機能維持）
- カメラ物理演算の根本的変更
- Cinemachineの基本設定変更

---

## 2. 機能要件

### 2.1 Core Requirements

#### REQ-001: リアルタイム視点切り替え
**優先度**: Critical  
**要件ID**: REQ-001

**機能概要**:
ゲームプレイ中に即座にFPSとTPSを切り替える機能

**詳細要件**:
- **REQ-001.1**: 指定キー（デフォルト：V）でのワンボタン切り替え
- **REQ-001.2**: コントローラー対応（デフォルト：Right Stick Click）
- **REQ-001.3**: 切り替え時間0.3秒以内での滑らかな遷移
- **REQ-001.4**: 遷移中の操作受付停止（重複防止）
- **REQ-001.5**: 切り替え失敗時のフォールバック処理

**受入基準**:
- [ ] 任意のゲーム状況でV키로即座切り替え可能
- [ ] 遷移アニメーションが0.3秒以内で完了
- [ ] 遷移中の重複入力が正しく無視される
- [ ] エラー時に前の状態に自動復帰する

#### REQ-002: 状況別制限機能
**優先度**: High  
**要件ID**: REQ-002

**機能概要**:
特定ゲーム状況での切り替え制限機能

**詳細要件**:
- **REQ-002.1**: カバー状態時の切り替え無効化
- **REQ-002.2**: エイム状態時の切り替え制限（設定可能）
- **REQ-002.3**: 特定アニメーション再生中の切り替え禁止
- **REQ-002.4**: カットシーン中の切り替え無効化
- **REQ-002.5**: 制限状態での視覚的フィードバック

**受入基準**:
- [ ] カバー中にV키가 무시됨
- [ ] エイム中の切り替え可否が設定通り動作
- [ ] 制限時にUI上で視覚的表示される
- [ ] 制限解除後に正常切り替え可能

#### REQ-003: 設定システム統合
**優先度**: High  
**要件ID**: REQ-003

**機能概要**:
プレイヤー設定との統合および永続化

**詳細要件**:
- **REQ-003.1**: デフォルト視点設定（ゲーム開始時）
- **REQ-003.2**: キーバインド カスタマイゼーション
- **REQ-003.3**: 切り替え速度調整（0.1秒〜1.0秒）
- **REQ-003.4**: エイム時切り替え可否設定
- **REQ-003.5**: 設定の自動保存・復元

**受入基準**:
- [ ] 設定メニューから全項目が変更可能
- [ ] ゲーム再起動後も設定が維持される
- [ ] 不正値入力時の自動補正機能
- [ ] デフォルト値への리セット기능

### 2.2 UI/UX Requirements

#### REQ-004: ユーザーインターフェース対応
**優先度**: High  
**要件ID**: REQ-004

**機能概要**:
視点切り替えに連動するUI表示制御

**詳細要件**:
- **REQ-004.1**: クロスヘア表示の動的切り替え（FPS時表示、TPS時非表示等）
- **REQ-004.2**: HUD要素の位置・サイズ自動調整
- **REQ-004.3**: 切り替え状態の視覚的インジケータ表示
- **REQ-004.4**: ツールチップ・ヘルプテキスト対応
- **REQ-004.5**: アクセシビリティ対応（色覚異常者向け表示等）

**受入基準**:
- [ ] 視点切り替え時にUI要素が適切に更新される
- [ ] 切り替え中の状態がプレイヤーに分かりやすく表示される
- [ ] 各視点でのUI表示が視認性良く配置される
- [ ] アクセシビリティガイドラインに準拠

#### REQ-005: フィードバックシステム
**優先度**: Medium  
**要件ID**: REQ-005

**機能概要**:
視点切り替え時のフィードバック機能

**詳細要件**:
- **REQ-005.1**: 切り替え成功時の音響フィードバック
- **REQ-005.2**: 切り替え不可時の警告音
- **REQ-005.3**: 振動フィードバック（コントローラー）
- **REQ-005.4**: 画面効果（フェード、スケール等）
- **REQ-005.5**: フィードバック強度設定

**受入基準**:
- [ ] 切り替え時に適切な音が再生される
- [ ] 不可時の警告が分かりやすく表示される
- [ ] フィードバック設定が正しく反映される
- [ ] パフォーマンスに悪影響を与えない

### 2.3 Integration Requirements

#### REQ-006: 既存システム統合
**優先度**: Critical  
**要件ID**: REQ-006

**機能概要**:
既存カメラシステムとの完全統合

**詳細要件**:
- **REQ-006.1**: `ViewModeController`との連携維持
- **REQ-006.2**: `CameraStateMachine`との状態同期
- **REQ-006.3**: `CinemachineIntegration`との協調動作
- **REQ-006.4**: 既存GameEventシステムとの統合
- **REQ-006.5**: CommandPatternとの統合（Undo/Redo対応）

**受入基準**:
- [ ] 既存のカメラ機能が全て正常動作
- [ ] 新機能追加後も既存APIが変更されない  
- [ ] イベント駆動アーキテクチャが維持される
- [ ] パフォーマンス劣化が発生しない

#### REQ-007: プレイヤーコントローラー統合
**優先度**: High  
**要件ID**: REQ-007

**機能概要**:
プレイヤー操作システムとの統合

**詳細要件**:
- **REQ-007.1**: 視点切り替え時のマウス感度調整
- **REQ-007.2**: 移動速度の視点別調整
- **REQ-007.3**: アニメーション状態との同期
- **REQ-007.4**: エイム精度の視点別最適化
- **REQ-007.5**: 当たり判定の視点別調整

**受入基準**:
- [ ] 各視点で操作感が適切に調整される
- [ ] 切り替え時の操作の一貫性が保たれる
- [ ] プレイヤーキャラクターの表示状態が正しい
- [ ] 物理演算との整合性が保たれる

---

## 3. 非機能要件

### 3.1 パフォーマンス要件

#### 3.1.1 応答性能
- **切り替え遅延**: 入力から視覚的変化まで100ms以内
- **遷移時間**: 滑らかな遷移アニメーション300ms以内完了
- **フレームレート影響**: 切り替え処理によるフレームドロップなし
- **メモリ使用量**: 機能追加による追加メモリ使用量5MB以内

#### 3.1.2 ストレステスト
- **連続切り替え**: 10秒間連続切り替えでも安定動作
- **同時処理**: 他のゲーム処理と並行実行時も60FPS維持
- **長時間プレイ**: 2時間連続プレイ後も機能劣化なし

### 3.2 互換性要件

#### 3.2.1 プラットフォーム
- **Windows**: Windows 10/11 (x64)
- **iOS**: iOS 12.0以降
- **Android**: API Level 21以降
- **WebGL**: モダンブラウザ対応

#### 3.2.2 入力デバイス
- **キーボード**: 全てのキーでのカスタムバインド対応
- **マウス**: ボタン・ホイールでのバインド対応
- **ゲームパッド**: XInput準拠コントローラー対応
- **タッチ**: モバイル向けタッチUI対応

### 3.3 品質要件

#### 3.3.1 信頼性
- **エラー率**: 切り替え失敗率0.1%以下
- **復旧時間**: エラー発生時の自動復旧5秒以内
- **データ整合性**: 設定データの破損防止機能

#### 3.3.2 使用性
- **学習時間**: 新規プレイヤーが機能を理解するまで30秒以内
- **直感性**: チュートリアルなしでも80%のプレイヤーが使用可能
- **アクセシビリティ**: WCAG 2.1 AA準拠

---

## 4. 技術制約

### 4.1 アーキテクチャ制約

#### 4.1.1 設計原則維持
- **イベント駆動型**: 既存GameEventシステムの活用必須
- **CommandPattern**: Undo/Redo機能との統合必須
- **ScriptableObject**: 設定管理の一貫性維持
- **ObjectPool**: メモリ最適化パターンの継続

#### 4.1.2 既存システム保護
- **API互換性**: 既存public APIの変更禁止
- **パフォーマンス**: 既存機能への影響なし
- **設定項目**: 既存設定の動作変更禁止

### 4.2 Unity固有制約

#### 4.2.1 バージョン制約
- **Unity**: 6000.0.42f1以降
- **URP**: Universal Render Pipeline 17.0.0以降
- **Cinemachine**: 3.1.0以降
- **Input System**: 新Input Systemベース必須

#### 4.2.2 プラットフォーム制約
- **モバイル**: 60FPS維持必須
- **WebGL**: ブラウザ制限への対応
- **コンソール**: プラットフォームTRC準拠

---

## 5. ユーザーストーリー

### 5.1 基本的なユースケース

#### US-001: 基本的な視点切り替え
**As a** プレイヤー  
**I want to** ゲームプレイ中にVキーを押して視点を切り替えたい  
**So that** 状況に応じて最適な視点でプレイできる

**受入条件**:
- Vキーを押すとFPS⇔TPSが即座に切り替わる
- 切り替え中も移動などの操作は継続可能
- 切り替え後の視点が自然で違和感がない

#### US-002: 設定のカスタマイズ
**As a** プレイヤー  
**I want to** 設定画面で視点切り替えをカスタマイズしたい  
**So that** 自分の好みに合わせてゲームを楽しめる

**受入条件**:
- 設定画面で切り替えキーを変更できる
- 切り替え速度を調整できる
- デフォルト視点を選択できる

### 5.2 高度なユースケース

#### US-003: 戦術的視点活用
**As a** 上級プレイヤー  
**I want to** 戦闘中に視点を切り替えて戦術的に有利になりたい  
**So that** より深いゲームプレイを楽しめる

**受入条件**:
- エイム時にFPSで精密射撃が可能
- 移動時にTPSで周囲状況を把握可能
- 切り替えタイミングが戦術に影響する

#### US-004: アクセシビリティ対応
**As a** 酔いやすいプレイヤー  
**I want to** 酔いを感じたら即座に視点を変更したい  
**So that** 快適にゲームを続行できる

**受入条件**:
- 任意のタイミングで即座に切り替え可能
- 酔いを軽減する視点設定が選択可能
- 切り替え時のカメラ揺れが最小限

---

## 6. 受入基準

### 6.1 機能テスト基準

#### 基本機能テスト
- [ ] **視点切り替え**: V키로FPS⇔TPS切り替えが正常動作
- [ ] **遷移時間**: 切り替え時間が0.3秒以内
- [ ] **状態保持**: 切り替え前後でプレイヤー状態が維持される
- [ ] **UI連動**: 視点に応じてUI要素が正しく更新される
- [ ] **設定保存**: カスタム設定がゲーム再起動後も維持される

#### 統合テスト
- [ ] **既存機能**: 全ての既存カメラ機能が正常動作
- [ ] **パフォーマンス**: 60FPS維持（target環境）
- [ ] **イベント**: GameEventシステムと正しく連動
- [ ] **入力システム**: 新Input Systemと正しく統合
- [ ] **Cinemachine**: Virtual Camera切り替えが正常動作

### 6.2 品質基準

#### パフォーマンステスト
- [ ] **メモリ使用量**: 追加使用量5MB以内
- [ ] **CPU使用率**: 切り替え時のスパイクなし
- [ ] **フレームレート**: 切り替え時も60FPS維持
- [ ] **バッテリー**: モバイルでの消費電力増加10%以内

#### ユーザビリティテスト
- [ ] **直感性**: 初回プレイヤーの80%が30秒以内に理解
- [ ] **応答性**: 入力から視覚変化まで100ms以内
- [ ] **一貫性**: 全プラットフォームで同じ操作感
- [ ] **エラー回復**: 問題発生時の自動復旧機能

### 6.3 セキュリティ・安定性

#### 安定性テスト
- [ ] **連続動作**: 10,000回連続切り替えでもエラーなし
- [ ] **メモリリーク**: 長時間プレイでのメモリ増加なし
- [ ] **例外処理**: 全てのエラーケースで適切な処理
- [ ] **設定破損**: 設定ファイル破損時の自動修復

---

## 7. リスク分析

### 7.1 技術リスク

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| Cinemachine統合問題 | 高 | 中 | 既存統合コード詳細調査・テスト強化 |
| パフォーマンス劣化 | 高 | 低 | プロファイリング継続・最適化 |
| UI同期問題 | 中 | 中 | UI更新イベント設計・テスト |
| 設定データ破損 | 中 | 低 | バックアップ・復元機能実装 |

### 7.2 UX リスク

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| 切り替え時の違和感 | 中 | 中 | プレイテスト・調整イテレーション |
| 誤操作による切り替え | 中 | 高 | 確認UI・設定による無効化機能 |
| デフォルト設定不適切 | 低 | 中 | ユーザビリティテスト実施 |

### 7.3 統合リスク

| リスク | 影響度 | 発生確률 | 対策 |
|--------|--------|----------|------|
| 既存機能破壊 | 高 | 低 | 段階的統合・リグレッションテスト |
| イベント系統複雑化 | 中 | 中 | アーキテクチャレビュー・簡素化 |
| 設定項目増加による混乱 | 低 | 中 | UI/UX設計での分かりやすさ重視 |

---

## 8. 成功メトリクス

### 8.1 定量的メトリクス

#### パフォーマンス指標
- **切り替え成功率**: 99.9%以上
- **平均切り替え時間**: 250ms以下  
- **フレームレート維持**: 60FPS維持率98%以上
- **メモリ効率**: 追加使用量目標値以内

#### 使用状況指標
- **機能利用率**: プレイヤーの60%以上が機能を使用
- **切り替え頻度**: 1セッションあたり平均5回以上
- **設定変更率**: プレイヤーの30%以上がデフォルト設定を変更

### 8.2 定性的メトリクス

#### ユーザー満足度
- **使いやすさ**: 5段階評価で平均4.0以上
- **レスポンシブネス**: 「即座に切り替わる」評価80%以上
- **違和感なし**: 「自然な切り替え」評価75%以上

#### 開発品質
- **バグ報告数**: リリース後1ヶ月以内に5件以下
- **パフォーマンス問題**: 報告件数ゼロ
- **既存機能影響**: 既存機能への悪影響報告ゼロ

---

## 9. 実装制約

### 9.1 スケジュール制約
- **設計期間**: 3日
- **実装期間**: 7日
- **テスト期間**: 5日
- **総期間**: 15日以内

### 9.2 リソース制約
- **開発者**: 1-2名
- **テスター**: 1名  
- **デザイナー**: UI/UX支援のみ

### 9.3 品質制約
- **テストカバレッジ**: 80%以上
- **コードレビュー**: 全変更への実施
- **ドキュメント**: 全API仕様書作成

---

**承認**

| 役割 | 氏名 | 日付 | 署名 |
|------|------|------|------|
| プロジェクトマネージャー | | | |
| 技術リーダー | | | |
| ゲームデザイナー | | | |
| QA責任者 | | | |
