# 3層アーキテクチャ 安全移行設計書

## 1. はじめに

### 1.1. 背景と目的
本ドキュメントは、プロジェクトを既存の構造から、`SPEC.md`で定義された**3層アーキテクチャ (`Core` ← `Feature` ← `Template`)** へと**安全に**移行するための技術設計と手順を定義する。目的は、関心事の分離、再利用性の向上、そして保守性の高いコードベースを確立することにある。

### 1.2. 安全な移行の定義
本ドキュメントにおける「安全な移行」とは、以下の条件を満たすことを指す：
- **リグレッションの防止**: 移行プロセス中に既存の機能を破壊しない。
- **段階的な適用**: 変更を小さく検証可能なステップに分割して実施する。
- **検証可能性**: 各ステップの完了後に、変更が正しく行われたことをテストで確認できる。
- **可逆性**: 問題が発生した場合に、特定のステップやフェーズを安全に元に戻せる（ロールバック可能）。

## 2. 移行準備 (Pre-Migration)

本格的な移行作業を開始する前に、安全な基盤を確保する。

### 2.1. バージョン管理戦略
1.  **移行専用ブランチの作成**:
    -   `Developer` ブランチから、`feature/3-layer-architecture-migration` という名称の長期間有効なフィーチャーブランチを作成する。すべての移行作業はこのブランチ上で行う。
2.  **タスク単位のサブブランチ**:
    -   各フェーズや主要なリファクタリングタスクごとに、移行ブランチからさらにサブブランチを作成する (例: `feature/phase1-asmdef-setup`)。
    -   作業完了後、サブブランチはプルリクエストを通じて `feature/3-layer-architecture-migration` ブランチにマージされる。これにより、すべての変更がレビュー可能となる。

### 2.2. 移行前チェックリスト
-   [ ] **安定性の確認**: `Developer`ブランチが安定しており、すべての既存テスト（ユニットテスト、プレイモードテスト）が100%パスすることを確認する。
-   [ ] **プロジェクトのバックアップ**: 万一の事態に備え、プロジェクト全体のバックアップを作成する。
-   [ ] **パフォーマンスベースラインの記録**: Unity Profilerを使用し、主要シーンのパフォーマンス（CPU使用率、メモリ確保、ドローコールなど）を記録する。これは移行後のパフォーマンスリグレッションを検出するために使用する。
-   [ ] **チームへの周知**: 移行計画とブランチ戦略について、開発チーム全体に周知徹底する。移行期間中の `Developer` ブランチへの直接の変更は原則としてフリーズする。

## 3. 段階的移行計画 (Phased Migration Plan)

移行は4つの主要フェーズに分けて実行する。各フェーズには明確な完了条件、検証手順、およびロールバック計画が含まれる。

---

### フェーズ1: 基盤整備 - Assembly Definitionの導入
**目的**: 依存関係の方向性 (`Template` → `Feature` → `Core`) をコンパイラレベルで強制する基盤を構築する。

-   **手順**:
    1.  `Assets/_Project/Core` に `asterivo.Unity60.Core.asmdef` を作成。参照はなし。
    2.  `Assets/_Project/Features/[機能名]` ごとに `asterivo.Unity60.Features.[機能名].asmdef` を作成。`asterivo.Unity60.Core` への参照を追加。
    3.  `Assets/_Project/Features/Templates/[ジャンル名]` ごとに `asterivo.Unity60.Features.Templates.[ジャンル名].asmdef` を作成。依存する `Feature` の `.asmdef` への参照を追加。

-   **安全性と検証**:
    -   この段階ではコードロジックの変更は行わないため、ランタイムの動作に影響はない。
    -   **検証**: プロジェクトを再コンパイルする。この時点で、新しいアセンブリ境界に起因する多数のコンパイルエラーが発生することを**期待する**。これは、依存関係が可視化された「制御された失敗」状態であり、フェーズ1の成功とみなす。

-   **ロールバック計画**:
    -   作成したすべての `.asmdef` ファイルを削除し、Gitの変更を破棄する。

---

### フェーズ2: `Core`層の確立
**目的**: プロジェクトの基盤となる汎用的なシステムを`Core`層に集約し、安定させる。

-   **手順**:
    1.  `ServiceLocator`, `GameEvent` システムなど、汎用的なスクリプトを `Assets/_Project/Core` 以下の適切なサブフォルダに移動する。
    2.  `Core`層の全スクリプトの名前空間を `asterivo.Unity60.Core.*` に統一する。
    3.  `Core`層の `.asmdef` が原因で発生しているコンパイルエラーを修正する。

-   **安全性と検証**:
    -   関連性の高いスクリプト群（例: イベントシステム関連）をまとめて移動し、その都度コンパイルとテストを行う。
    -   **検証**: `Core`層に関連するユニットテストがすべてパスすること。`Core`層のコードが `Feature` や `Template` 層を一切参照していないことを静的解析ツールや目視で確認する。

-   **ロールバック計画**:
    -   このフェーズで行ったファイル移動と名前空間の変更を含むコミットをリバートする。

---

### フェーズ3: `Feature`層の抽出とリファクタリング
**目的**: ゲームの各機能を独立した `Feature` として抽出し、`GameEvent` を用いて疎結合化する。これは移行の最も重要なフェーズである。

-   **手順**:
    1.  **一度に一つのFeature**: `Player` 機能など、一つの機能に絞って作業を開始する。
    2.  関連するスクリプト、プレハブ、アセットを `Assets/_Project/Features/Player` フォルダに移動する。
    3.  名前空間を `asterivo.Unity60.Features.Player` に統一する。
    4.  **依存関係の解消**: `Player` が他の `Feature` (例: `UI`, `Inventory`) を直接参照している箇所を特定し、`Core`層の `GameEvent` を介した通信にリファクタリングする。

-   **安全性と検証**:
    -   **テスト駆動リファクタリング**: 重要なロジック（例: ヘルスが減った際のUI更新）をリファクタリングする前に、その振る舞いを保証するプレイモードテストを作成する。リファクタリング後もこのテストがパスすることを確認する。
    -   **アダプターパターンの活用**: 大規模なリファクタリングが困難な場合、一時的に「アダプター」コンポーネントを作成する。このコンポーネントはイベントをリッスンし、古いコード（直接参照）を呼び出す役割を担う。これにより、段階的な移行が可能になる。
    -   **厳格なコードレビュー**: `Feature` をリファクタリングするプルリクエストは、必ず他の開発者によるレビューを必須とする。

-   **ロールバック計画**:
    -   機能単位でコミットを管理するため、問題が発生した `Feature` のみの変更をリバートできる。これにより、他の正常に移行が完了した `Feature` への影響を最小限に抑える。

---

### フェーズ4: `Template`層の構築と最終検証
**目的**: 独立した `Feature` 群を組み合わせて、ゲームとしての完全な動作を保証する。

-   **手順**:
    1.  シーン、設定済みプレハブ、バランス調整用アセットを `Assets/_Project/Features/Templates/[ジャンル名]` に移動する。
    2.  プレハブやシーン内の参照（Missing Reference）を、`Feature` 層に移動したコンポーネントに再接続する。

-   **安全性と検証**:
    -   **シーンごとのテスト**: 一つのシーンを完全に移行し、プレイテストで動作確認が完了してから次のシーンに着手する。
    -   **リグレッションテスト**: 事前に定義したテストケースリストに基づき、すべてのゲーム機能が意図通りに動作するかを網羅的にテストする。
    -   **パフォーマンス検証**: 移行準備フェーズで記録したベースラインと、移行後のパフォーマンスを比較する。顕著なパフォーマンス低下がないことを確認する。

-   **ロールバック計画**:
    -   シーンやプレハブの移動と参照の再設定に関するコミットをリバートする。

## 4. リスク分析と軽減策

-   **リスク1: 予期せぬ循環参照の発生**
    -   **影響**: コンパイル不能、エディタの不安定化。
    -   **軽減策**: `.asmdef` がコンパイルレベルでこれを防ぐ。ロジック上で循環参照が必要になった場合、それは設計上の問題を示唆している。その際は、`GameEvent` を追加するか、責務を再分割することで対応する。

-   **リスク2: イベント駆動によるパフォーマンス低下**
    -   **影響**: フレームレートの低下、特に高頻度で発行されるイベント。
    -   **軽減策**: パフォーマンスベースラインとの比較を徹底する。特に `Update` 内で毎フレーム発行されるようなイベントは避ける。パフォーマンスが重要な箇所では、`GameEvent` の代わりに C# の `event` や `UnityEvent` の使用も検討するが、原則として疎結合を優先する。

-   **リスク3: 大規模リファクタリングによるマージコンフリクト**
    -   **影響**: 開発の停滞、マージミスによるバグ。
    -   **軽減策**: 移行専用のブランチで作業を隔離する。移行期間中は `Developer` ブランチでの新規機能開発を凍結することが最も安全である。

## 5. 移行完了後のタスク (Post-Migration)

-   [ ] **旧ディレクトリのクリーンアップ**: `Assets/_Project/Scripts` など、不要になった古いフォルダを削除する。
-   [ ] **開発者ドキュメントの更新**: `CLAUDE.md` やプロジェクトのコーディング規約を更新し、新しい3層アーキテクチャのルール（ファイル配置、名前空間、依存関係）を明記する。
-   [ ] **メインブランチへのマージ**: すべての検証が完了し、チームの承認を得た後、`feature/3-layer-architecture-migration` ブランチを `main` ブランチにマージする。
-   [ ] **最終バックアップ**: 移行が完了した安定バージョンとして、プロジェクトの最終バックアップを作成する。
