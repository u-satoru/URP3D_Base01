# 3層アーキテクチャ移行 詳細タスクリスト

**参照設計書**: `Assets/_Project/Docs/Works/20250922_1005/3-Layer-Architecture-Safe-Migration-Design.md`

## 凡例
-   **優先度**: [P0: 必須], [P1: 高], [P2: 中]
-   **見積もり**: [S: 小], [M: 中], [L: 大]
-   **依存**: このタスクを開始する前に完了しているべきタスクID

---

## フェーズ 0: 移行準備 (Pre-Migration)
**目的**: 移行作業全体のリスクを低減し、安全な基盤を確立する。

-   **タスク 0.1: 移行ブランチの作成**
    -   **優先度**: [P0: 必須]
    -   **見積もり**: [S: 小]
    -   **内容**: `Developer`ブランチから`feature/3-layer-architecture-migration`ブランチを作成する。
    -   **完了条件**: 新しいブランチがリモートリポジトリにプッシュされ、チームメンバーがアクセス可能であること。

-   **タスク 0.2: 既存テストの完全性を保証**
    -   **優先度**: [P0: 必須]
    -   **見積もり**: [S: 小]
    -   **依存**: タスク 0.1
    -   **内容**: `feature/3-layer-architecture-migration`ブランチ上で、全てのユニットテストおよびプレイモードテストを実行し、100%パスすることを確認する。
    -   **完了条件**: テストランナーの結果レポートが保存され、全テストがグリーンであること。

-   **タスク 0.3: プロジェクトの完全バックアップ**
    -   **優先度**: [P0: 必須]
    -   **見積もり**: [M: 中]
    -   **内容**: プロジェクトフォルダ全体（`Library`フォルダを含む）を圧縮し、安全な場所に保管する。
    -   **完了条件**: バックアップファイルが作成され、その場所がチームに共有されていること。

-   **タスク 0.4: パフォーマンスベースラインの測定**
    -   **優先度**: [P1: 高]
    -   **見積もり**: [M: 中]
    -   **内容**: 主要な3つのシーン（例: タイトル、メインゲーム、ボス戦）について、Unity Profilerを使用し、以下の項目を記録する: 平均FPS、CPU使用時間（`RenderThread`, `MainThread`）、メモリ確保量（`Total Reserved`, `GC Allocated per frame`）、`Draw Calls`数。
    -   **完了条件**: 測定結果がスクリーンショットと数値データで記録され、共有ドキュメントにまとめられていること。

---

## フェーズ 1: 基盤整備 - Assembly Definition
**目的**: 3層間の依存関係をコンパイラレベルで強制し、意図しない参照を不可能にする。

-   **タスク 1.1: Core層 Assembly Definition の作成**
    -   **優先度**: [P0: 必須]
    -   **見積もり**: [S: 小]
    -   **依存**: タスク 0.2
    -   **内容**: `Assets/_Project/Core`に`asterivo.Unity60.Core.asmdef`を作成する。`Assembly Definition References`は空にする。
    -   **完了条件**: ファイルが作成され、Unityが再コンパイルを完了すること。

-   **タスク 1.2: Feature層 Assembly Definition の作成**
    -   **優先度**: [P0: 必須]
    -   **見積もり**: [L: 大]
    -   **依存**: タスク 1.1
    -   **内容**: `Assets/_Project/Features`配下の各機能フォルダ（`Player`, `AI`, `UI`など）に、対応する`.asmdef`ファイルを作成する。各`.asmdef`は`asterivo.Unity60.Core.asmdef`への参照を持つ。
    -   **完了条件**: 全ての`Feature`フォルダに`.asmdef`が配置されていること。

-   **タスク 1.3: Template層 Assembly Definition の作成**
    -   **優先度**: [P0: 必須]
    -   **見積もり**: [M: 中]
    -   **依存**: タスク 1.2
    -   **内容**: `Assets/_Project/Features/Templates`配下の各ジャンルフォルダに、対応する`.asmdef`ファイルを作成する。各`.asmdef`は、そのテンプレートが依存する`Feature`の`.asmdef`への参照を持つ。
    -   **完了条件**: 全ての`Template`フォルダに`.asmdef`が配置されていること。

-   **タスク 1.4: 意図的なコンパイルエラーの確認**
    -   **優先度**: [P0: 必須]
    -   **見積もり**: [S: 小]
    -   **依存**: タスク 1.3
    -   **内容**: Unity Editorでコンソールを確認し、依存関係違反によるコンパイルエラーが大量に発生していることを確認する。
    -   **完了条件**: コンパイルエラーのスクリーンショットを撮り、これが「制御された失敗」であることをチームに共有すること。

---

## フェーズ 2: Core層の確立
**目的**: 汎用的なコードを`Core`層に集約し、プロジェクトの安定した土台を再構築する。

-   **タスク 2.1: Core層候補スクリプトの特定と移動**
    -   **優先度**: [P0: 必須]
    -   **見積もり**: [M: 中]
    -   **依存**: タスク 1.4
    -   **内容**: `ServiceLocator`, イベントシステム, 各種デザインパターン基盤など、ジャンルや機能に依存しないスクリプトを`Assets/_Project/Core`以下の適切なサブフォルダに移動する。
    -   **完了条件**: 移動対象のスクリプトがすべて`Core`フォルダ配下に配置されていること。

-   **タスク 2.2: Core層の名前空間統一とリファクタリング**
    -   **優先度**: [P0: 必須]
    -   **見積もり**: [M: 中]
    -   **依存**: タスク 2.1
    -   **内容**: `Core`層に移動した全てのスクリプトの名前空間を`asterivo.Unity60.Core.*`に統一し、関連するコンパイルエラーを修正する。
    -   **完了条件**: `asterivo.Unity60.Core`アセンブリが単体でコンパイル可能になり、エラーが0になること。

-   **タスク 2.3: Core層のユニットテスト修正と実行**
    -   **優先度**: [P1: 高]
    -   **見積もり**: [M: 中]
    -   **依存**: タスク 2.2
    -   **内容**: `Core`層に関連するユニットテストを修正し、すべてパスすることを確認する。
    -   **完了条件**: `Core`層のテストカバレッジが維持され、テストがすべてグリーンであること。

---

## フェーズ 3: Feature層の抽出と疎結合化
**目的**: 各機能を独立した再利用可能なモジュールとして確立する。（Featureごとに下記タスクセットを繰り返す）

### Feature: Player
-   **タスク 3.1.1: Player関連アセットの移動**
    -   **優先度**: [P0: 必須]
    -   **見積もり**: [M: 中]
    -   **依存**: タスク 2.3
    -   **内容**: Playerに関連するスクリプト、プレハブ、アニメーション、モデル等を`Assets/_Project/Features/Player`に移動する。
    -   **完了条件**: 関連アセットがすべて移動され、プロジェクト構造が整理されていること。

-   **タスク 3.1.2: Player層の名前空間統一**
    -   **優先度**: [P0: 必須]
    -   **見積もり**: [S: 小]
    -   **依存**: タスク 3.1.1
    -   **内容**: Player関連スクリプトの名前空間を`asterivo.Unity60.Features.Player`に統一する。
    -   **完了条件**: `asterivo.Unity60.Features.Player`アセンブリ内のコンパイルエラーが、外部依存に関するもののみになること。

-   **タスク 3.1.3: 外部依存関係の洗い出しとリファクタリング計画**
    -   **優先度**: [P0: 必須]
    -   **見積もり**: [M: 中]
    -   **依存**: タスク 3.1.2
    -   **内容**: `Player`スクリプトが直接参照している他の`Feature`（例: `UIManager`, `InventoryManager`）をすべてリストアップし、それぞれを`GameEvent`に置き換えるための具体的な計画を立てる。
    -   **完了条件**: 依存関係リストと、使用する`GameEvent`（既存または新規作成）の対応表が作成されていること。

-   **タスク 3.1.4: 依存関係のリファクタリング実行**
    -   **優先度**: [P0: 必須]
    -   **見積もり**: [L: 大]
    -   **依存**: タスク 3.1.3
    -   **内容**: 計画に基づき、直接参照を`GameEvent`の発行・購読に置き換える。
    -   **完了条件**: `asterivo.Unity60.Features.Player`アセンブリがコンパイル可能になり、他の`Feature`アセンブリへの直接参照がなくなること。

-   **タスク 3.1.5: Player機能のテスト検証**
    -   **優先度**: [P1: 高]
    -   **見積もり**: [M: 中]
    -   **依存**: タスク 3.1.4
    -   **内容**: Player機能がリファクタリング後も正しく動作することを、既存のテストと新規に作成したテストで確認する。
    -   **完了条件**: Player機能に関連するテストがすべてパスすること。

---

## フェーズ 4: Template層の構築と最終検証
**目的**: 全ての`Feature`を統合し、ゲーム全体が正常に動作することを保証する。

-   **タスク 4.1: Templateアセットの移動と再設定**
    -   **優先度**: [P0: 必須]
    -   **見積もり**: [L: 大]
    -   **依存**: 全てのフェーズ3タスク
    -   **内容**: シーン、プレハブ、`ScriptableObject`を適切な`Template`フォルダに移動し、`Missing Reference`を修正する。
    -   **完了条件**: 全ての`Template`シーンがエラーなくロードでき、プレハブの参照がすべて解決されていること。

-   **タスク 4.2: エンドツーエンドのリグレッションテスト**
    -   **優先度**: [P0: 必須]
    -   **見積もり**: [L: 大]
    -   **依存**: タスク 4.1
    -   **内容**: 各`Template`の主要なゲームサイクル（開始→プレイ→終了）をテストし、すべての機能が意図通りに連携して動作することを確認する。
    -   **完了条件**: 事前に作成したリグレッションテストのシナリオがすべてパスすること。

-   **タスク 4.3: 最終パフォーマンステスト**
    -   **優先度**: [P1: 高]
    -   **見積もり**: [M: 中]
    -   **依存**: タスク 4.2
    -   **内容**: タスク 0.4で記録したベースラインと現在のパフォーマンスを比較する。
    -   **完了条件**: パフォーマンスに顕著な悪化が見られないこと。問題があれば、原因を特定し修正タスクを作成すること。

---

## フェーズ 5: 移行完了
**目的**: 移行作業を公式に完了し、プロジェクトを通常開発サイクルに戻す。

-   **タスク 5.1: プロジェクトのクリーンアップ**
    -   **優先度**: [P2: 中]
    -   **見積もり**: [S: 小]
    -   **依存**: タスク 4.3
    -   **内容**: 不要になった古いフォルダやファイルを削除する。
    -   **完了条件**: プロジェクト構造が3層アーキテクチャに完全に準拠していること。

-   **タスク 5.2: 開発ドキュメントの更新**
    -   **優先度**: [P1: 高]
    -   **見積もり**: [M: 中]
    -   **依存**: タスク 5.1
    -   **内容**: `GEMINI.md`やその他の開発ガイドを更新し、新しいアーキテクチャのルールを反映させる。
    -   **完了条件**: ドキュメントが更新され、チームに共有されていること。

-   **タスク 5.3: `main`ブランチへのマージ**
    -   **優先度**: [P0: 必須]
    -   **見積もり**: [S: 小]
    -   **依存**: タスク 5.2
    -   **内容**: `feature/3-layer-architecture-migration`ブランチを`main`にマージする。
    -   **完了条件**: マージが完了し、`main`ブランチで最終テストがパスすること。
