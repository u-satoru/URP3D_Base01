# Phase 4.2: エンドツーエンドリグレッションテストシナリオ
**作成日**: 2025年9月24日
**フェーズ**: Template層の構築と最終検証
**参照**: 3-Layer-Architecture-Migration-Design.md, 3-Layer-Architecture-Safe-Migration-Design.md

## 概要
本ドキュメントは、3層アーキテクチャ移行後の各Templateの主要ゲームサイクル（開始→プレイ→終了）をテストするためのシナリオを定義します。

## テスト実施前提条件
- ✅ Phase 4.1のアセット移動完了
- ⚠️ Unity Editor内でのMissing Reference確認必要
- ⚠️ コンパイルエラー0件確認必要

## 共通テスト項目（全Template共通）

### 1. 起動テスト
```
1.1 シーンの読み込み
    - シーンが正常にロードされること
    - Missing Referenceがないこと
    - Console Windowにエラーがないこと

1.2 初期化処理
    - ServiceLocatorへのサービス登録が完了すること
    - GameEventリスナーの登録が正常に行われること
    - 初期状態のステートマシンが正常に動作すること
```

### 2. コア機能テスト
```
2.1 ServiceLocatorテスト
    - AudioManagerがServiceLocator経由でアクセス可能
    - GameManagerがServiceLocator経由でアクセス可能
    - InputManagerがServiceLocator経由でアクセス可能

2.2 EventSystemテスト
    - GameEventの発行と受信が正常に動作
    - Feature層間の通信がGameEvent経由で動作
    - Template層からFeature層へのイベント送信が動作
```

### 3. 終了テスト
```
3.1 リソース解放
    - ObjectPoolの適切な解放
    - EventListenerの登録解除
    - ServiceLocatorのクリーンアップ
```

## Template別テストシナリオ

### 🎭 Stealth Template テスト

#### シーン: StealthAudioTest.unity
**テスト項目**:
1. **AI視覚センサー検証**
   - NPCがプレイヤーを視認範囲内で検出
   - 障害物による視線遮断が機能
   - 警戒レベルの段階的上昇

2. **AI聴覚センサー検証**
   - 足音による検知範囲の確認
   - 環境マスキング効果の動作
   - 音源距離による減衰計算

3. **ステルス機能統合**
   - プレイヤーのしゃがみ移動による検知回避
   - 影の中での隠蔽ボーナス
   - AIの追跡・探索行動

**期待結果**:
- NPCのマルチモーダルセンサー統合が正常動作
- プレイヤーのステルス行動が適切に評価

---

### 🔫 TPS Template テスト

#### シーン: TPSTemplateTest.unity
**テスト項目**:
1. **カメラシステム検証**
   - 三人称視点の正常動作
   - エイムモードへの切り替え
   - カバーモードでのカメラ制御

2. **武器システム検証**
   - 武器の装備・切り替え
   - リロード処理
   - 弾薬管理

3. **戦闘システム検証**
   - ダメージコマンドの実行
   - ヘルスシステムの動作
   - ヒットフィードバック

**期待結果**:
- シューティングゲームの基本サイクルが完全動作
- カメラとプレイヤー制御の連携が適切

---

### 🎨 Common Templates テスト

#### シーン: AudioSystemDemo.unity
**テスト項目**:
1. **3D空間オーディオ**
   - 音源の3D定位
   - 距離による減衰
   - ドップラー効果

2. **オーディオイベント連携**
   - GameEventによるサウンド再生
   - 環境音の動的変化

**期待結果**:
- オーディオシステムが全Template共通で動作

#### シーン: BasicMovementDemo.unity
**テスト項目**:
1. **プレイヤー移動**
   - 歩行・走行の切り替え
   - ジャンプ機能
   - CharacterControllerの物理挙動

2. **アニメーション連携**
   - 移動状態とアニメーションの同期
   - ブレンドの滑らかさ

**期待結果**:
- 基本移動システムが全ジャンルで再利用可能

#### シーン: CombatSystemDemo.unity
**テスト項目**:
1. **コマンドパターン動作**
   - DamageCommandの実行
   - HealCommandの実行
   - ObjectPoolによる最適化確認

2. **戦闘フロー**
   - 攻撃→ダメージ→回復のサイクル
   - Undo/Redo機能（該当する場合）

**期待結果**:
- コマンドシステムがメモリ効率的に動作

#### シーン: UISystemDemo.unity
**テスト項目**:
1. **UI応答性**
   - ボタンクリック応答
   - スライダー操作
   - テキスト更新

2. **イベント駆動UI**
   - ヘルス表示の自動更新
   - スコア表示の連携

**期待結果**:
- UIがイベント駆動で疎結合に動作

#### シーン: EventSystemDemo.unity
**テスト項目**:
1. **イベント発行・購読**
   - GameEventの基本動作
   - 型付きイベントの動作
   - 複数リスナーへの通知

2. **層間通信**
   - Core→Feature通信なし（制約確認）
   - Feature→Template通信なし（制約確認）

**期待結果**:
- 3層アーキテクチャの依存関係制約が守られている

---

### 🧪 Adventure Template テスト

#### シーン: TestAdventureProject.unity
**テスト項目**:
1. **インタラクションシステム**
   - オブジェクトとの相互作用
   - UI表示の連動

2. **ナラティブ機能**
   - ダイアログシステム
   - クエスト進行

**期待結果**:
- アドベンチャーゲームの基本フローが動作

---

## パフォーマンステスト

### メモリ効率測定
```
- ObjectPool使用前後のメモリ使用量比較
- 目標: 95%メモリ削減効果の確認
```

### 実行速度測定
```
- コマンド実行時間の測定
- 目標: 67%速度改善の確認
```

### フレームレート測定
```
- 各Templateでの安定60FPS維持確認
- GC.Allocの監視
```

## テスト実施手順

### 1. Unity Editorでの実施
```bash
1. Unity 6000.0.42f1を起動
2. プロジェクトを開く
3. 各シーンを順番に開いて実行
4. Console Windowでエラー・警告を確認
5. Unity Profilerでパフォーマンスを測定
```

### 2. チェックリスト記録
```
□ シーンロード成功
□ Missing Reference: 0件
□ コンパイルエラー: 0件
□ ランタイムエラー: 0件
□ 警告メッセージ数: ___件
□ 平均FPS: ___fps
□ メモリ使用量: ___MB
□ GC.Alloc/Frame: ___KB
```

### 3. 問題発見時の対応
```
1. エラーログの詳細記録
2. スクリーンショット取得
3. 再現手順の文書化
4. 修正タスクの作成
```

## 成功基準

### 必須要件（MUST）
- ✅ 全シーンが正常にロード可能
- ✅ コンパイルエラー: 0件
- ✅ Missing Reference: 0件
- ✅ ランタイムエラー: 0件
- ✅ 3層アーキテクチャ依存関係制約の遵守

### 推奨要件（SHOULD）
- ⭐ 60FPS安定維持
- ⭐ メモリ効率目標達成（95%削減）
- ⭐ 実行速度目標達成（67%向上）
- ⭐ 警告メッセージ最小化

## 次のステップ

1. **Unity Editorでのテスト実施**
   - 各シーンの順次テスト
   - チェックリスト記録

2. **問題修正（発見時）**
   - Missing Reference修正
   - エラー対応

3. **Phase 4.3準備**
   - パフォーマンスベースライン比較
   - 最終レポート作成

---
**備考**: 本テストシナリオは、Unity Editor内での手動テストを前提としています。自動テストへの拡張は将来のフェーズで検討します。