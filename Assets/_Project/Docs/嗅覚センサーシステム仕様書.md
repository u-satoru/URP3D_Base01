# 嗅覚センサーシステム仕様案

## 1. 概要

NPCが、プレイヤーや特定のオブジェクトが発する「匂い」を検知するためのシステム。匂いは発生源から時間経過と共に拡散し、徐々に消えていく。風や天候などの環境要因によって影響を受ける。

## 2. ゲームプレイ上の役割

-   **追跡要素の強化**: プレイヤーが出血している場合、その血の匂いを辿って敵が追跡してくる。
-   **新たなステルス要素**: 匂いを消すアイテムを使ったり、水場に入ることで匂いを消し、追跡を振り切る。
-   **誘導・探索**: 特定の匂い（例：食料の匂い）に引き寄せられるクリーチャーや、匂いを頼りに隠されたアイテムを見つけ出すコンパニオンAI。
-   **危険察知**: 敵が特定の匂い（例：火薬の匂い、天敵の匂い）を嫌ってそのエリアを避ける。

## 3. アーキテクチャ統合方針

既存のセンサーシステムとイベント駆動アーキテクチャを拡張する形で実装します。

1.  **匂いの発生源 (`ScentSource`)**: 匂いを発するオブジェクト（プレイヤー、アイテム、死体など）にアタッチするコンポーネント。
2.  **匂いの実体 (`ScentCloud`)**: 匂いを空間内のオブジェクトとして表現。時間経過で拡散（スケールが拡大）し、消滅（匂いの強度が低下）する。
3.  **匂い管理システム (`ScentManager`)**: 全ての `ScentCloud` を管理するグローバルなサービス。`ServiceLocator` を通じてアクセスする。匂いの拡散、消滅、環境要因の計算などを一括して行う。
4.  **NPC嗅覚センサー (`NPCOlfactorySensor`)**: NPCにアタッチし、周囲の `ScentCloud` を検知するコンポーネント。
5.  **設定用アセット (`OlfactorySensorSettings`)**: センサーの感度や検知範囲などを定義する `ScriptableObject`。

## 4. 主要コンポーネント設計

### A. `ScentSource.cs` (匂いの発生源)

-   **役割**: 周期的に、または特定の条件下で `ScentCloud` を生成するよう `ScentManager` にリクエストする。
-   **プロパティ**:
    -   `ScentProfile` (`ScriptableObject`): 匂いの種類（血、食料、腐敗臭など）、初期強度、持続時間などを定義。
    -   `emissionRate` (float): 匂いを放出する頻度。
    -   `isActive` (bool): 匂いを発しているかどうかのフラグ。
-   **イベント連携**:
    -   例：プレイヤーのHPが一定以下になったら `PlayerBleedingEvent` を購読し、`isActive` を `true` にする。

### B. `ScentManager.cs` (シングルトン or サービス)

-   **役割**: 全ての `ScentCloud` のライフサイクルを管理する。
-   **主な処理**:
    -   `Update()`内で、アクティブな全 `ScentCloud` の強度を減衰させ、半径を広げる（拡散シミュレーション）。
    -   強度がゼロになった `ScentCloud` をプールに戻すか破棄する。
    -   （拡張）風向きや強さを考慮し、`ScentCloud` の移動をシミュレートする。
    -   （拡張）雨が降っている場合、`ScentCloud` の消滅を早める。

### C. `NPCOlfactorySensor.cs` (NPCの鼻)

-   **役割**: 視覚や聴覚センサーと同様に、AIの五感の一部として機能する。
-   **プロパティ**:
    -   `settings` (`OlfactorySensorSettings`): 検知範囲、感度などの設定アセット。
    -   `detectionRadius` (float): 匂いを検知できる範囲。
-   **主な処理**:
    -   一定間隔で `ScentManager` に問い合わせ、自身の検知範囲内にある `ScentCloud` のリストを取得する。
    -   検知した匂いの強度と種類に基づき、AIの警戒レベルや行動を決定するためのイベントを発行する。
-   **イベント発行**:
    -   `OlfactoryScentDetectedEvent` を発行。パラメータとして匂いの種類、強度、位置情報などを渡す。

## 5. イベントフロー設計

**例：プレイヤーが出血し、敵がそれを嗅ぎつけて調査に来る**

1.  **イベント発行**:
    -   プレイヤーのHPが50%未満になる。
    -   `PlayerHealth.cs` が `PlayerBleedingEvent` を発行する。
2.  **匂いの発生**:
    -   プレイヤーにアタッチされた `ScentSource.cs` が `PlayerBleedingEvent` を購読している。
    -   イベントを受け取り、`ScentManager.Instance.EmitScent(transform.position, bloodScentProfile)` のようなメソッドを呼び出し、定期的に「血の匂い」の `ScentCloud` を生成し始める。
3.  **匂いの拡散**:
    -   `ScentManager` が、生成された `ScentCloud` を管理リストに追加。毎フレーム、その強度を少しずつ下げ、範囲を広げていく。プレイヤーが移動すると、その軌跡に沿って匂いの雲が点々と残る。
4.  **匂いの検知**:
    -   敵NPCの `NPCOlfactorySensor.cs` が、自身の範囲内で `ScentManager` が管理する「血の匂い」の `ScentCloud` を検知する。
5.  **AIへの通知**:
    -   `NPCOlfactorySensor.cs` が `OlfactoryScentDetectedEvent` を発行する。イベントには「血の匂い、強度0.8、位置(x,y,z)」といった情報が含まれる。
6.  **AIの行動変化**:
    -   敵NPCの `AIStateMachine.cs` が `OlfactoryScentDetectedEvent` を購読している。
    -   イベントを受け取り、現在の状態が `PatrolState` であれば、匂いの発生源を調査するために `InvestigatingState` に遷移する。`InvestigatingState` は、イベントで渡された位置情報へ移動するロジックを持つ。

## 6. 拡張性の考慮

-   **匂いのマスキング**: 匂いを消すアイテム（消臭スプレー）や、より強い匂い（腐肉など）で別の匂いを上書きするギミック。
-   **風システム**: `WindManager` を作り、`ScentManager` がその情報を参照して匂いの雲を特定の方向に流す。
-   **プレイヤー側の嗅覚**: プレイヤーも特定の匂いを可視化（探偵モードのように）できる能力。
