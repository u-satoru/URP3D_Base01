# テンプレート共通機能の分析とCore層へのリファクタリング提案

## 1. 概要

このドキュメントは、`Stealth`、`FPS`、`Platformer`の3つのゲームジャンルテンプレートに共通して必要となる機能を分析し、それらをプロジェクトの`Core`層に移行することの妥当性を検討し、具体的なリファクタリング案を提示するものです。

この提案は、プロジェクトの設計原則である「関心の分離」を徹底し、コードの再利用性を最大化することで、将来のテンプレート追加や機能拡張を加速させることを目的とします。

## 2. 分析対象テンプレート

- **Stealth Template**: AIによる検知、隠密行動、環境とのインタラクションが主軸。
- **FPS Template**: 一人称視点での射撃、戦闘、UI操作が主軸。
- **Platformer Template**: ジャンプや移動などの物理ベース制御、アイテム収集、ギミック操作が主軸。

## 3. 共通機能の抽出とCore層への移行提案

上記のテンプレート要件を分析した結果、以下の5つの機能がジャンルを横断する共通基盤として抽出されました。これらを`Core`層に実装し、各テンプレート（`Features`層）が利用するアーキテクチャを提案します。

---

### 3.1. 汎用的なキャラクター制御システム (Generic Character Controller)

- **現状の課題**: 各テンプレートで個別にプレイヤーの移動や物理挙動を実装すると、類似コードが散在し、保守性が低下する恐れがあります。
- **提案**:
    - キャラクターの基本的な移動（歩行、走行、ジャンプ、しゃがみ等）のロジックをカプセル化する、物理ベースの`CharacterMover`コンポーネントを`Core`層に作成します。
    - このコンポーネントは、`InputService`（後述）からの入力を受け取り、`Rigidbody`や`CharacterController`を介してキャラクターを動かします。
- **Core層への配置理由**: キャラクターの物理的な移動は、ほぼ全ての3Dゲームで必要となる最も基本的な機能です。これを`Core`に置くことで、あらゆる`Features`が一貫した方法でキャラクターを制御できます。
- **実装イメージ**:
    - `asterivo.Unity60.Core.Character` 名前空間
    - `CharacterMover.cs`: Rigidbodyへの力適用、接地判定、速度制限などの基本機能を提供。
    - `PlayerStateMachine`（Features層）は、この`CharacterMover`を参照して具体的な状態（歩行状態、ジャンプ状態など）を制御します。

---

### 3.2. 汎用的なインタラクションシステム (Generic Interaction System)

- **現状の課題**: アイテム取得、ドアの開閉、スイッチ操作など、オブジェクトとのインタラクションは各テンプレートで必要ですが、個別の実装は非効率です。
- **提案**:
    - `IInteractable`インターフェースを`Core`層に定義します。インタラクション可能なオブジェクト（ドア、アイテム、ボタン等）は、このインターフェースを実装します。
    - プレイヤー側に`Interactor`コンポーネントを作成します。これはプレイヤーの前方にある`IInteractable`オブジェクトを検知し、入力に応じてインタラクションを実行します。
- **Core層への配置理由**: 「オブジェクトに近づいて何かアクションを起こす」という概念は、ゲームジャンルを問わない普遍的なメカニクスです。この仕組みを`Core`で提供することで、`Features`層はインタラクションの「具体的な中身」を実装することに集中できます。
- **実装イメージ**:
    - `asterivo.Unity60.Core.Interaction` 名前空間
    - `IInteractable.cs`: `void Interact(Interactor interactor);` メソッドを持つインターフェース。
    - `Interactor.cs`: カメラの前方にRaycastを飛ばし、`IInteractable`を検知して`Interact()`を呼び出す。

---

### 3.3. 汎用的なカメラ制御システム (Generic Camera Control System)

- **現状の課題**: FPSの一人称視点、TPSの三人称視点、Platformerの追従カメラなど、カメラ要件は多様ですが、状態の切り替えや管理の仕組みは共通化できます。
- **提案**:
    - `DESIGN.md`で言及されている`CinemachineIntegration`および`CameraStateMachine`の基盤部分を`Core`層に配置します。
    - `Core`層では、カメラ状態（例: `FirstPerson`, `ThirdPerson`, `Aim`）を管理し、イベントに応じてスムーズに切り替えるための汎用的なステートマシンを提供します。
    - 各テンプレートは、このカメラシステムに対して、具体的なカメラ設定（`CinemachineVirtualCamera`のプリセットなど）を提供する`ScriptableObject`を定義します。
- **Core層への配置理由**: カメラの状態管理と遷移の仕組みは、特定のゲームロジックから独立した技術的な基盤です。データ駆動設計（ScriptableObject）と組み合わせることで、`Core`の汎用システムと`Features`の個別設定を綺麗に分離できます。

---

### 3.4. 汎用的な入力管理システム (Generic Input Management System)

- **現状の課題**: UnityのInput Systemは強力ですが、各機能が直接参照すると密結合になります。入力処理を抽象化する層が必要です。
- **提案**:
    - `InputService`を`Core`層に作成し、`ServiceLocator`に登録します。
    - このサービスは、Unityの`PlayerInput`からのコールバックを受け取り、それを抽象的なゲーム内イベント（例: `OnMoveInput`, `OnJumpInputPressed`）に変換して`GameEvent`として発行します。
- **Core層への配置理由**: 入力デバイスからの生データを解釈し、システム全体で利用可能なイベントに変換するプロセスは、アプリケーションの最下層に位置するべきコアな関心事です。これにより、どの`Features`も入力デバイスの詳細を意識することなく、意味のあるアクションに集中できます。

---

### 3.5. 汎用的な体力・ダメージシステム (Generic Health & Damage System)

- **現状の課題**: FPSでの被弾、Stealthでの発見後のダメージ、Platformerでの敵との接触など、ダメージを受ける概念は広く共通しています。
- **提案**:
    - `HealthComponent`を`Core`層に作成します。これには、現在の体力、最大体力、ダメージを受ける処理、死亡時のイベントなどが含まれます。
    - `DamageCommand`や`HealCommand`といったコマンドを`Core`層で具体的に実装し、`ObjectPool`から利用できるようにします。これにより、誰が誰にどれだけのダメージを与えたかを、コマンドオブジェクトとして効率的に扱えます。
- **Core層への配置理由**: 体力とダメージは、多くのゲームにおける基本的なステータス管理の一部です。プロジェクトの`Command Pattern`アーキテクチャと親和性が非常に高く、`Core`のコマンドシステムを拡張する自然な形となります。

## 4. 結論と次のステップ

上記で提案した5つのシステムを`Core`層に移行することにより、`Features`層はより高レベルなゲームロジックの実装に集中でき、テンプレート間のコード重複を劇的に削減できます。これにより、開発効率と保守性が大幅に向上し、「究極のUnity 6ベーステンプレート」というプロジェクトのビジョン達成に大きく貢献します。

