# Phase 5 残存エラー分析レポート

**作成日時**: 2025年9月16日
**作業フェーズ**: Phase 5 重大実装エラー修正
**ステータス**: 部分完了（主要エラー解決済み、残存エラー14件）

## 📊 修復完了サマリー

### ✅ 解決済みエラー（Phase 5で修正完了）

| 優先度 | エラータイプ | 修正内容 | 影響ファイル数 |
|--------|-------------|----------|---------------|
| Critical | ServiceLocator using directives | `using asterivo.Unity60.Core;` 追加 | 3ファイル |
| Critical | AlertLevel enum mapping | Core.Data.AlertLevel値（Unaware/Suspicious/Alert/Combat）に正しくマッピング | 1ファイル |
| High | ServiceLocator API | `Instance.Register` → `RegisterService` 修正 | 1ファイル |
| Medium | Camera namespace conflict | `Camera.main` → `UnityEngine.Camera.main` 明示化 | 1ファイル |

**合計解決エラー**: 約20件のコンパイルエラーを修正

## ⚠️ 残存エラー詳細分析

### 🔴 Critical Level - Assembly参照問題 (14件)

#### エラータイプ: `CS0234 - The type or namespace name 'IStealthMechanicsService' does not exist`

**影響ファイル**:
- `HidingSpotInteractionCommand.cs` (4箇所)
- `StealthMechanics.cs` (1箇所)
- `StealthTemplateManager.cs` (2箇所)

**具体的エラー**:
```csharp
// Line 298-307: HidingSpotInteractionCommand.cs
var stealthController = ServiceLocator.GetService<asterivo.Unity60.Core.Services.IStealthMechanicsService>();
//                                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
//                                                 CS0234: 'IStealthMechanicsService' does not exist
```

**問題分析**:
1. **Assembly Definition参照不整合**: `asterivo.Unity60.Features.Templates.Stealth.asmdef`が`asterivo.Unity60.Core.Services`を参照しているが、実際のIStealthMechanicsServiceが見つからない
2. **名前空間不一致**: 実際のIStealthMechanicsServiceが異なる名前空間に存在する可能性
3. **Interface実装不足**: インターフェース自体が未実装または不完全

**推奨解決策**:
```csharp
// Option 1: 完全修飾名での参照
using asterivo.Unity60.Core.Services;  // 実際の名前空間を確認
var stealthController = ServiceLocator.GetService<IStealthMechanicsService>();

// Option 2: 一時的回避（null許容）
var stealthController = ServiceLocator.GetService<IStealthMechanicsService>();
if (stealthController != null) {
    // 処理続行
} else {
    Debug.LogWarning("StealthMechanicsService not available");
}
```

### 🟡 High Level - 名前空間エラー (2件)

#### エラータイプ: `CS0234 - The type or namespace name 'DetectionType' does not exist`

**影響ファイル**:
- `StealthEnvironmentManager.cs` (Line 216, 360)

**具体的エラー**:
```csharp
// Line 216: StealthEnvironmentManager.cs
asterivo.Unity60.Features.Templates.Stealth.DetectionType detectionType;
//                                             ^^^^^^^^^^^^
//                                             CS0234: 'DetectionType' does not exist
```

**問題分析**:
1. **DetectionType定義缺失**: `asterivo.Unity60.Features.Templates.Stealth`名前空間にDetectionTypeが存在しない
2. **正しい場所**: DetectionTypeが`asterivo.Unity60.Core.Data`に移動されている可能性

**推奨解決策**:
```csharp
// 正しい名前空間参照を追加
using asterivo.Unity60.Core.Data;

// または完全修飾名で使用
asterivo.Unity60.Core.Data.DetectionType detectionType;
```

### 🟠 Medium Level - Missing Implementation (10件)

#### エラータイプ: `CS1061 - does not contain a definition for`

**影響ファイル**:
- `StealthTemplateValidator.cs` (8件)
- `StealthGameplayManager.cs` (2件)

**具体的エラー**:
```csharp
// StealthTemplateValidator.cs - Missing Properties
config.templateName         // CS1061: 'templateName' not found
config.templateVersion       // CS1061: 'templateVersion' not found
config.targetGameplayDuration // CS1061: 'targetGameplayDuration' not found
config.estimatedLearningTime  // CS1061: 'estimatedLearningTime' not found
config.MechanicsConfig       // CS1061: 'MechanicsConfig' not found
config.AIConfig              // CS1061: 'AIConfig' not found
config.AudioConfig           // CS1061: 'AudioConfig' not found

// StealthGameplayManager.cs - Missing Methods
stealthUI.UpdateGlobalAlertLevel() // CS1061: 'UpdateGlobalAlertLevel' not found
```

**問題分析**:
1. **ScriptableObject設計不完全**: `StealthTemplateConfig`に必要なプロパティが未実装
2. **UI Manager API不整合**: `StealthUIManager`にメソッドが未実装
3. **設計仕様とコード実装のギャップ**: 要件定義されたAPIが実装されていない

**推奨解決策**:
```csharp
// StealthTemplateConfig.cs に不足プロパティを追加
[CreateAssetMenu(menuName = "Stealth/Template Config")]
public class StealthTemplateConfig : ScriptableObject
{
    [Header("Template Information")]
    public string templateName = "Stealth Template";
    public string templateVersion = "1.0.0";

    [Header("Gameplay Settings")]
    public float targetGameplayDuration = 30.0f; // minutes
    public float estimatedLearningTime = 15.0f;  // minutes

    [Header("Component Configs")]
    public StealthMechanicsConfig MechanicsConfig;
    public StealthAIConfig AIConfig;
    public StealthAudioConfig AudioConfig;
}

// StealthUIManager.cs に不足メソッドを追加
public void UpdateGlobalAlertLevel(float alertLevel)
{
    // Implementation needed
    Debug.Log($"Global alert level updated to: {alertLevel}");
}
```

### 🔵 Low Level - Type Conversion (2件)

#### エラータイプ: `CS1503 - Argument cannot convert`

**具体的エラー**:
```csharp
// StealthGameplayManager.cs:448
CompleteObjective(objective); // Cannot convert 'StealthMissionObjective' to 'string'

// StealthTemplateManager.cs:167
ServiceLocator.RegisterService<IStealthMechanicsService>(stealthMechanics);
// Cannot convert 'StealthMechanics' to 'IStealthMechanicsService'
```

**推奨解決策**:
```csharp
// Type conversion fixes
CompleteObjective(objective.ObjectiveName); // Extract string property

// Interface implementation verification
public class StealthMechanics : MonoBehaviour, IStealthMechanicsService
{
    // Ensure proper interface implementation
}
```

## 📋 修復優先順位 & アクションプラン

### Phase 5A: Critical Assembly修復 (推定工数: 2-3時間)

1. **IStealthMechanicsService Assembly定義修復**
   - Core.Services assembly definitionの確認と修正
   - Interface定義の完全性検証
   - 依存関係の再構築

2. **DetectionType名前空間統一**
   - Core.Dataへの正しい参照追加
   - Feature層での重複定義削除

### Phase 5B: Missing Implementation追加 (推定工数: 3-4時間)

1. **StealthTemplateConfig拡張**
   - 必須プロパティ8件の実装
   - ScriptableObject Inspector UI最適化

2. **StealthUIManager API完成**
   - UpdateGlobalAlertLevel メソッド実装
   - UI更新ロジック統合

### Phase 5C: Type安全性向上 (推定工数: 1-2時間)

1. **Interface実装確認**
   - StealthMechanics → IStealthMechanicsService実装検証
   - Type conversion修正

2. **Final Integration Test**
   - 全エラー解決後のコンパイル検証
   - 基本機能動作確認

## 📈 成功指標

### 完了条件
- [ ] コンパイルエラー 0件達成
- [ ] 警告レベル 5件以下
- [ ] 基本ステルス機能動作確認
- [ ] NPCVisualSensor統合動作確認

### 品質指標
- [ ] Assembly参照整合性100%
- [ ] Interface実装完全性100%
- [ ] ScriptableObject設定完全性100%

## 🔧 技術メモ

### Assembly Definition構造
```
asterivo.Unity60.Core
├── asterivo.Unity60.Core.Services (IStealthMechanicsService)
└── asterivo.Unity60.Core.Data (DetectionType, AlertLevel)

asterivo.Unity60.Features.Templates.Stealth
├── References: asterivo.Unity60.Core.Services ✅
└── References: asterivo.Unity60.Core.Data ✅
```

### ServiceLocator API Pattern
```csharp
// 現在の正しいパターン (静的メソッド)
ServiceLocator.RegisterService<T>(service);
var service = ServiceLocator.GetService<T>();

// 旧パターン (削除済み)
ServiceLocator.Instance.Register<T>(service); // ❌ Instance無し
```

---

**次のアクション**: Phase 5A Critical Assembly修復から開始推奨
**想定完了**: 2-3セッション (6-9時間)
**リスク**: Assembly定義根本問題が複雑な場合、追加調査時間が必要
