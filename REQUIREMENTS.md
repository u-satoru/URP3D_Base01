# REQUIREMENTS.md - Unity 6 3Dゲーム基盤プロジェクト 形式化された要件定義

## アーキテクチャとデザインパターン
- **ServiceLocator + Event駆動のハイブリッドアーキテクチャ（最重要）**:グローバルサービスへのアクセスとイベントベースの通信を組み合わせたハイブリッドアプローチ。Singletonパターンは使用禁止。
- **イベント駆動型アーキテクチャ**: `GameEvent` を介したコンポーネント間の疎結合な連携。
- **コマンドパターン**: ゲーム内のアクション（例：ダメージ、回復）をオブジェクトとしてカプセル化し、再利用と管理を容易にします。
- **ObjectPool最適化**: 頻繁に作成・破棄されるコマンドオブジェクトをプール化し、メモリ効率とパフォーマンスを大幅に向上させます（95%のメモリ削減効果）。
- **Scriptable Objectベースのデータ管理**: キャラクターのステータスやアイテム情報などをアセットとして管理。
- **UniTask非同期パターン**: コルーチンからUniTaskへの段階的移行による、ゼロアロケーション非同期処理の実現。

## 文書管理情報

- **ドキュメント種別**: 形式化された要件定義書（SDDフェーズ2: 形式化）
- **生成元**: SPEC.md - Unity 6 3Dゲーム基盤プロジェクト 初期構想・要件定義
- **トレーサビリティ**: SPEC.md の核心価値と実装方針を形式化し、後続 DESIGN.md 生成の基盤として機能
- **対象読者**: 開発者、アーキテクト、プロジェクトマネージャー
- **更新日**: 2025年9月20日（Service Locator優先順位変更・コアシステム要件整合）
- **整合性状態**: SPEC.md v3.3 との完全整合性確保済み（アーキテクチャ優先順位明確化）

## プロジェクト識別情報

### プロジェクト定義
- **プロジェクトID**: URP3D_Base01
- **正式名称**: **究極のUnity 6ベース 3Dゲーム開発基盤テンプレート**
- **プロジェクト分類**: ゲーム開発フレームワーク・テンプレート
- **開発手法**: スペック駆動開発（SDD）+ イベント駆動アーキテクチャ
- **核心ビジョン**: 4つの核心価値の実現
  - **Clone & Create**: リポジトリクローンから1分でゲーム開発開始
  - **Learn & Grow**: 初心者から上級者まで段階的成長をサポート
  - **Ship & Scale**: プロトタイプからプロダクションまで完全対応
  - **Community & Ecosystem**: 活発なコミュニティとエコシステム形成

### ステークホルダー要件マトリクス

| ステークホルダー | 優先度 | 主要要求事項 | 受益内容 | 究極テンプレート要件 |
|---|---|---|---|---|
| Unity開発者（中級～上級） | 最高 | モダンアーキテクチャ学習、実装品質向上 | 開発効率150%向上、コード品質改善 | 学習コスト70%削減（12時間以内） |
| ゲーム開発チーム | 最高 | 疎結合設計、協調開発支援 | チーム生産性向上、競合削減 | セットアップ時閗1分以内、自動ビルド |
| インディーゲーム開発者 | 高 | 高品質基盤、開発時間短縮 | 限定リソースでの効率的開発 | 6ジャンルテンプレート、アセット統合ガイド |
| ゲームデザイナー | 中 | コード非依存バランス調整 | 独立したゲームデザイン作業 | ゲームプレイ設定、多言語対応 |
| サウンドデザイナー | 中 | 高品質3D空間オーディオ | リアルな音響体験創造 | 統合音響システム、AI連動 |

### 究極テンプレート成功指標

#### 定量的目標要件（SPEC.md v3.0 究極テンプレート完全対応）
- **セットアップ時間短縮**: 現在30分 → 目標1分（97%短縮）
- **学習コスト削減**: 現在40時間 → 目標12時間（70%削減）
- **開発速度向上**: 既存比150%向上
- **バグ発生率削減**: 60%削減
- **リリース準備時間短縮**: 80%短縮
- **メモリ効率維持**: ObjectPoolにより95%のメモリ削減効果維持
- **実行効率維持**: コマンド実行で67%の速度改善維持

#### 4つの核心価値実現要件（究極テンプレートビジョン）
- **Clone & Create**: リポジトリクローンから1分でゲーム開発開始、初心者でも迷わずセットアップ可能
- **Learn & Grow**: 初心者から上級者まで段階的成長をサポート、Unity中級開発者が1週間で基本概念習得可能
- **Ship & Scale**: プロトタイプからプロダクションまで完全対応、任意のゲームジャンルに即座対応

#### 定性的目標要件
- **Clone & Create**: 初心者でも迷わずセットアップ可能
- **Learn & Grow**: Unity中級開発者が1週間で基本概念習得可能
- **Ship & Scale**: 任意のゲームジャンルに即座対応

## 対象ゲームジャンル・最適化仕様

### 最適化対象ジャンル

#### ステルスアクションゲーム（最優先）
- **要件**: NPCのマルチモーダルAIセンサーシステムの完全実装（視覚、聴覚、嗅覚）。
- **詳細**: 環境マスキング効果による音響・嗅覚制御、AI警戒レベル連動システム。
- **成功基準**: リアルなステルスゲームプレイの実現。

#### サバイバルホラーゲーム（高優先）
- **要件**: プレイヤーの無力感と心理的圧迫を演出するシステムの統合。
- **詳細**: 厳格なリソース管理、永続的な脅威となるストーカー型AI、プレイヤーの精神状態を反映する心理的恐怖システム。
- **成功基準**: 持続的な緊張感とカタルシスのあるサバイバル体験の実現。

#### 3Dプラットフォーマー（高優先）
- **要件**: 応答性の高いCharacterControllerベースの移動システム。
- **詳細**: カメラ状態管理、ジャンプ・落下・着地の状態管理。
- **成功基準**: 流体的なプラットフォームアクションの実現。

#### TPS/FPSゲーム（高優先）
- **要件**: Cinemachine 3.1統合カメラシステムとコンバットシステム基盤。
- **詳細**: プレイヤー状態管理（戦闘、移動）、武器・弾薬管理。
- **成功基準**: 競技性の高いシューティングゲームプレイの基盤提供。

### 対応可能ジャンル

#### アクションRPG（中優先）
- **要件**: RPG要素統合システム（キャラクター成長、スキルシステム、インベントリ管理）。
- **詳細**: ScriptableObjectベースのキャラクターステータス、レベルアップシステム、アイテム・装備システム。
- **成功基準**: アクション性を重視したRPGゲームプレイの基盤提供。

## 機能要件（Functional Requirements）

### FR-1: コアアーキテクチャシステム

#### FR-1.1 ServiceLocator + Event駆動ハイブリッドアーキテクチャ（最重要）
- **要件ID**: FR-1.1
- **優先度**: 最高（Critical） - **コアアーキテクチャの第1優先事項**
- **要件**: グローバルサービスへの統一アクセスとイベントベース通信の統合
- **詳細仕様**:
  - `ServiceLocator.cs`: 全グローバルサービス（オーディオ/ゲームマネージャー等）の登録・取得を管理
  - `IService`インターフェース: サービス基本契約
  - `GameEvent<T>`: 型安全なイベントチャネルとの連携
  - Singletonパターンの完全排除（ServiceLocatorで代替）
  - 依存性注入不要、可読性・保守性向上
- **実装効果**:
  - 関心事の分離・拡張性・再利用性・メンテナンス性向上
  - イベント駆動型と組み合わせた疎結合通信の実現
- **受入条件**:
  - 全サービスがServiceLocator経由でアクセス可能
  - イベント通信による疎結合実現
  - Singletonパターン使用箇所ゼロ
  - Core層でのServiceLocator積極活用

#### FR-1.2 イベント駆動アーキテクチャ
- **要件ID**: FR-1.2
- **優先度**: 最高（Critical）
- **要件**: ScriptableObjectベースのイベントシステム
- **詳細仕様**:
  - `GameEvent.cs`: イベント発行クラス
  - `GameEventListener.cs`: イベント購読コンポーネント
  - `EventChannelRegistry.cs`: イベント管理レジストリ
  - HashSet<T>によるO(1)パフォーマンス
- **受入条件**:
  - コンポーネント間の直接参照なし
  - イベントによる完全な疎結合通信
  - メモリリーク防止（WeakReference使用）

#### FR-1.3 コマンドパターン＋ObjectPool統合実装
- **要件ID**: FR-1.3
- **優先度**: 最高（Critical）
- **要件**: アクションのカプセル化と実行管理、ObjectPoolによる最適化統合
- **詳細仕様**:
  - `ICommand`インターフェース: Execute/Undo/CanUndo
  - `CommandInvoker.cs`: コマンド実行管理
  - `CommandHistory.cs`: 実行履歴管理
  - Factory+Registry+ObjectPool統合実装
  - DamageCommand, HealCommand等の再利用可能コマンドシステム
  - Undo/Redoサポート
- **期待効果**:
  - 95%メモリ削減効果
  - 67%実行速度改善
- **受入条件**:
  - 全ゲームアクションがコマンド化
  - Undo機能の完全実装
  - コマンド履歴の永続化対応
  - ObjectPoolによるメモリ最適化達成

#### FR-1.4 ObjectPool最適化システム
- **要件ID**: FR-1.4
- **優先度**: 最高（Critical）
- **要件**: メモリ効率とパフォーマンスの最大化
- **詳細仕様**:
  - `CommandPoolManager.cs`: コマンドオブジェクトプール管理
  - `IResettableCommand`: リセット可能コマンドインターフェース
  - 自動拡張・縮小機能
  - 統計・監視機能
- **受入条件**:
  - 95%のメモリ削減達成
  - 67%の実行速度改善達成
  - ゼロアロケーション実現

### FR-2: データ管理システム

#### FR-2.1 ScriptableObjectベースデータ管理
- **要件ID**: FR-2.1
- **優先度**: 高（Must Have）
- **要件**: データとロジックの完全分離
- **詳細仕様**:
  - `CharacterStats.asset`: キャラクターパラメータ
  - `WeaponData.asset`: 武器情報
  - `ItemData.asset`: アイテム定義
  - `GameSettings.asset`: ゲーム設定
- **受入条件**:
  - 全データがScriptableObject化
  - コード変更なしでバランス調整可能
  - Odin Inspectorによる編集UI最適化

#### FR-2.2 データ検証システム
- **要件ID**: FR-2.2
- **優先度**: 高（Must Have）
- **要件**: データ整合性の自動検証
- **詳細仕様**:
  - Odin Validatorによる自動検証
  - ビルド前チェック機能
  - カスタム検証ルール
  - エラーレポート生成
- **受入条件**:
  - ビルド時の自動検証実行
  - データ不整合の即座検出
  - 詳細なエラーレポート出力

### FR-3: ステートマシンシステム

#### FR-3.1 階層化ステートマシン（HSM）
- **要件ID**: FR-3.1
- **優先度**: 高（Must Have）
- **要件**: 複雑な状態管理の階層化サポート
- **詳細仕様**:
  - `HierarchicalStateMachine.cs`: 階層構造管理
  - `IState`インターフェース: OnEnter/OnUpdate/OnExit
  - `StateFactory.cs`: 状態生成管理
  - 親子状態の継承関係
- **受入条件**:
  - ネスト状態の完全サポート
  - 状態遷移のイベント駆動
  - ロジック継承の実現

#### FR-3.2 プレイヤー状態管理
- **要件ID**: FR-3.2
- **優先度**: 高（Must Have）
- **要件**: プレイヤーキャラクターの状態制御
- **詳細仕様**:
  - 8状態: Idle/Walking/Running/Jumping/Falling/Attacking/Damaged/Dead
  - 状態遷移ルール定義
  - アニメーション連動
  - 入力制御統合
- **受入条件**:
  - 全状態の適切な遷移
  - アニメーションとの同期
  - 入力応答性の維持

#### FR-3.3 カメラ状態管理
- **要件ID**: FR-3.3
- **優先度**: 高（Must Have）
- **要件**: 動的カメラ制御システム
- **詳細仕様**:
  - 4状態: FirstPerson/ThirdPerson/Aim/Cover
  - Cinemachine 3.1統合
  - スムーズな状態遷移
  - プレイヤー状態連動
- **受入条件**:
  - カメラ切り替えの滑らか性
  - 状態間の適切な補間
  - 入力遅延なし

#### FR-3.4 AI状態管理
- **要件ID**: FR-3.4
- **優先度**: 高（Must Have）
- **要件**: NPC行動制御システム
- **詳細仕様**:
  - 7状態: Idle/Patrol/Suspicious/Investigating/Searching/Alert/Combat
  - NavMeshAgent統合
  - Behavior Tree連携
  - Memory System実装
- **受入条件**:
  - 自然なAI行動遷移
  - プレイヤー検知の適切性
  - パフォーマンス最適化

### FR-4: AIセンサーシステム

#### FR-4.1 視覚センサーシステム
- **要件ID**: FR-4.1
- **優先度**: 高（Must Have）
- **要件**: NPCの視覚検知機能
- **詳細仕様**:
  - `NPCVisualSensor.cs`: 視界スキャン実装
  - 視野角・距離パラメータ
  - 障害物判定（Raycast）
  - 4段階警戒レベル
- **受入条件**:
  - リアルな視覚検知
  - 10-20Hz更新頻度
  - 50体NPC同時稼働

#### FR-4.2 聴覚センサーシステム
- **要件ID**: FR-4.2
- **優先度**: 高（Must Have）
- **要件**: NPCの音響検知機能
- **詳細仕様**:
  - `NPCAuditorySensor.cs`: 3D音響検知
  - 距離減衰計算
  - 環境マスキング効果
  - 音源タイプ識別
- **受入条件**:
  - 物理的に正確な音響伝播
  - 環境音の影響考慮
  - リアルタイム処理

#### FR-4.3 嗅覚センサーシステム
- **要件ID**: FR-4.3
- **優先度**: 中（Should Have）
- **要件**: NPCの匂い検知機能
- **詳細仕様**:
  - `NPCOlfactorySensor.cs`: 嗅覚検知
  - `OdorSource.cs`: 匂い発生源
  - `WindSystem.cs`: 風向・風速管理
  - 匂いの伝播シミュレーション
- **受入条件**:
  - 風向による匂い拡散
  - 時間経過による減衰
  - 複数匂い源の処理

#### FR-4.4 センサー統合システム
- **要件ID**: FR-4.4
- **優先度**: 高（Must Have）
- **要件**: マルチモーダルセンサー統合
- **詳細仕様**:
  - `StealthSensorCoordinator.cs`: センサー統合管理
  - 重み付け優先度システム
  - 総合警戒レベル算出
  - AIStateMachine連携
- **受入条件**:
  - 全センサー情報の統合
  - 適切な優先度判定
  - リアルタイム応答性

### FR-5: オーディオシステム

#### FR-5.1 3D空間オーディオ
- **要件ID**: FR-5.1
- **優先度**: 高（Must Have）
- **要件**: リアルな3D音響体験
- **詳細仕様**:
  - `AudioManager.cs`: 中央音響管理
  - 3D空間定位
  - 距離減衰・ドップラー効果
  - 環境リバーブ
- **受入条件**:
  - 正確な音源定位
  - 自然な音響効果
  - パフォーマンス最適化

#### FR-5.2 動的音響環境
- **要件ID**: FR-5.2
- **優先度**: 中（Should Have）
- **要件**: 環境による音響変化
- **詳細仕様**:
  - `DynamicAudioEnvironment.cs`: 環境音響管理
  - オーディオゾーン定義
  - 材質による反響変化
  - 天候による音響効果
- **受入条件**:
  - リアルな環境音響
  - スムーズな遷移
  - メモリ効率性

### FR-6: プレイヤーシステム

#### FR-6.1 キャラクター移動制御
- **要件ID**: FR-6.1
- **優先度**: 最高（Critical）
- **要件**: 応答性の高い移動システム
- **詳細仕様**:
  - `PlayerController.cs`: 移動制御
  - CharacterController使用
  - 物理ベース移動
  - ジャンプ・ダッシュ機能
- **受入条件**:
  - 16ms以内の入力応答
  - 滑らかな移動制御
  - 物理的に自然な挙動

#### FR-6.2 インタラクションシステム
- **要件ID**: FR-6.2
- **優先度**: 高（Must Have）
- **要件**: オブジェクトとの相互作用
- **詳細仕様**:
  - `IInteractable`インターフェース
  - `Interactor.cs`: インタラクション管理
  - 範囲検知システム
  - UI表示連動
- **受入条件**:
  - 直感的な操作性
  - 明確なフィードバック
  - 拡張可能な設計

### FR-7: カメラシステム

#### FR-7.1 Cinemachine統合
- **要件ID**: FR-7.1
- **優先度**: 高（Must Have）
- **要件**: 高度なカメラ制御
- **詳細仕様**:
  - Cinemachine 3.1完全統合
  - VirtualCamera管理
  - ブレンド制御
  - ポストプロセシング連携
- **受入条件**:
  - プロ品質のカメラワーク
  - スムーズな遷移
  - 低遅延実現

#### FR-7.2 視点切り替えシステム
- **要件ID**: FR-7.2
- **優先度**: 高（Must Have）
- **要件**: 動的な視点変更
- **詳細仕様**:
  - 一人称/三人称切り替え
  - エイムモード対応
  - カバーカメラ実装
  - 状態保持機能
- **受入条件**:
  - 即座の視点切り替え
  - 違和感のない遷移
  - 状態の適切な管理

### FR-8: テンプレートシステム

#### FR-8.1 Interactive Setup Wizard
- **要件ID**: FR-8.1
- **優先度**: 最高（Critical）
- **要件**: 1分以内のセットアップ実現
- **詳細仕様**:
  - 環境診断機能
  - 自動設定最適化
  - パッケージ自動インポート
  - エラー自動修復
- **受入条件**:
  - git clone → Play: 1分以内
  - エラーゼロ起動
  - 初心者対応UI

#### FR-8.2 Game Genre Templates
- **要件ID**: FR-8.2
- **優先度**: 最高（Critical）
- **要件**: 7ジャンル対応テンプレート
- **対応ジャンル**:
  1. **Stealth Template**: ステルスアクション
  2. **Survival Horror Template**: サバイバルホラー
  3. **FPS Template**: 一人称シューティング
  4. **TPS Template**: 三人称シューティング
  5. **Platformer Template**: プラットフォーマー
  6. **Adventure Template**: アドベンチャー
  7. **Action RPG Template**: アクションRPG
- **受入条件**:
  - 各テンプレート15分プレイ可能
  - 完全動作サンプルシーン
  - カスタマイズ可能設計

#### FR-8.3 Learning System
- **要件ID**: FR-8.3
- **優先度**: 高（Must Have）
- **要件**: 段階的学習サポート
- **詳細仕様**:
  - 5段階学習カリキュラム
  - インタラクティブチュートリアル
  - サンプルコード提供
  - ベストプラクティスガイド
- **受入条件**:
  - 12時間で基本習得
  - 進捗トラッキング
  - 理解度テスト合格

### FR-9: サバイバルホラー特化システム

#### FR-9.1 リソース欠乏管理システム
- **要件ID**: FR-9.1
- **優先度**: 高（Should Have）
- **要件**: 弾薬、回復アイテム、キーアイテムの希少性を管理し、プレイヤーに戦略的判断を強制するシステム。
- **詳細仕様**:
  - `ResourceManager.cs`: シーン内の消費アイテムの総量を管理・監視するサービス。
  - `InventoryComponent.cs`: 厳格なスロット制限を持つインベントリ。
  - `ItemBoxComponent.cs`: インベントリ外のアイテムを保管するストレージ。
  - **リソースベースセーブ**: セーブに行動回数や特定アイテム（例：インクリボン）の消費を要求するオプション機能。
- **受入条件**:
  - アイテムの配置と消費のバランスが、プレイヤーに常に緊張感を与えること。
  - インベントリ管理が、探索と戦闘における重要な戦略的要素として機能すること。
  - リソースベースのセーブ機能が、高難易度モードなどで有効化できること。

#### FR-9.2 雰囲気・心理的恐怖システム
- **要件ID**: FR-9.2
- **優先度**: 高（Should Have）
- **要件**: 環境とプレイヤーの心理状態を動的に変化させ、持続的な不安と恐怖を演出するシステム。
- **詳細仕様**:
  - `AtmosphereManager.cs`: 照明、フォグ、環境音、天候などを統合管理し、ゲームの進行やプレイヤーの状態に応じて変化させるサービス。
  - `SanitySystem.cs`: プレイヤーの正気度やストレスレベルを管理するコンポーネント。
  - **トリガー**: 長時間暗闇にいる、敵を直視する、不穏なイベントを目撃するなど。
  - **効果**: 正気度の低下に応じて、視覚・聴覚の幻覚、操作精度の低下、敵に発見されやすくなるなどのペナルティが発生する。
  - **ダイジェティックUI**: 体力や状態異常を、キャラクターの見た目（息遣い、足取り）や画面エフェクトで表現する。
- **受入条件**:
  - 環境演出がプレイヤーに心理的な圧迫感を与えること。
  - 正気度システムが、プレイヤーに新たなリソース管理の軸とリスクをもたらすこと。
  - UIが没入感を阻害せず、直感的にプレイヤーの状態を伝えられること。

#### FR-9.3 ストーカー型AIシステム
- **要件ID**: FR-9.3
- **優先度**: 高（Should Have）
- **要件**: プレイヤーを永続的に追跡し、ゲームプレイに常に緊張感をもたらすストーカー型AIの基盤。
- **詳細仕様**:
  - `StalkerAIController.cs`: 特定のエリア内を徘徊し、プレイヤーの痕跡（音、匂い）を追跡する高度なAI。
  - **永続性**: 一時的に撃退・回避は可能だが、完全に倒すことはできず、時間経過や特定トリガーで再出現する。
  - **適応的行動**: プレイヤーの隠れ場所を推測したり、回り込んで奇襲したりするなど、予測しにくい行動パターンを持つ。
  - **心理的連携**: プレイヤーの正気度が低いほど、より攻撃的かつ執拗になる。
- **受入条件**:
  - ストーカーAIがプレイヤーにとって予測不能かつ恒常的な脅威として機能すること。
  - プレイヤーが「安全地帯は存在しない」という感覚を持つこと。
  - AIの挙動が単調にならず、ゲームプレイを通じて多様な駆け引きが生まれること。

(以降の非機能要件、技術要件などは変更なし)
...
(FR-8.1.2 Game Genre Templates System の項目を以下のように更新)

##### FR-8.1.2 Game Genre Templates System
- **要件ID**: FR-8.1.2
- **優先度**: 最高（Critical）
- **要件**: 7ジャンル対応テンプレートシステム
- **対応ジャンル**:
  1. **Stealth Template** - ステルスアクション
  2. **Survival Horror Template** - サバイバルホラー
  3. **FPS Template** - 一人称シューティング
  4. **TPS Template** - 三人称シューティング
  5. **Platformer Template** - プラットフォーマー
  6. **Adventure Template**: アドベンチャー
  7. **Action RPG Template**: アクションRPG

### FR-10: サードパーティライブラリ統合要件

#### FR-10.1 DOTween Pro統合
- **要件ID**: FR-10.1
- **優先度**: 高（Must Have）
- **要件**: DOTween Proによる高品質アニメーションシステムの統合
- **詳細仕様**:
  - UIアニメーション、カメラ遷移、エフェクトアニメーションへの統合
  - UniTaskとの連携による非同期アニメーション制御
  - パフォーマンス最適化（プーリング、キャッシング）
- **受入条件**:
  - 全UIアニメーションがDOTween Pro経由で実行される
  - UniTaskとのシームレスな統合（`.ToUniTask()`メソッド）
  - メモリリーク防止（適切なKill処理）

#### FR-10.2 Odin Inspector/Validator/Serializer統合
- **要件ID**: FR-10.2
- **優先度**: 高（Must Have）
- **要件**: Odinスイートによる開発効率とデータ整合性の向上
- **詳細仕様**:
  - **Odin Inspector**: カスタムインスペクターUI、ScriptableObject編集強化
  - **Odin Validator**: プロジェクト整合性の自動検証、ビルド前チェック
  - **Odin Serializer**: 複雑なデータ構造のシリアライゼーション
- **受入条件**:
  - 全ScriptableObjectがOdin Inspectorで最適化されたUI表示
  - ビルド前の自動検証によるエラー防止
  - 複雑なネスト構造のデータ保存・読み込み対応

#### FR-10.3 UniTask非同期処理統合
- **要件ID**: FR-10.3
- **優先度**: 最高（Critical）
- **要件**: コルーチンからUniTaskへの段階的移行と完全統合
- **詳細仕様**:
  - 新規実装は全てUniTask使用必須
  - 既存コルーチンの段階的移行計画
  - CancellationToken統一管理システム
  - DOTweenとの統合（`Tween.ToUniTask()`）
- **受入条件**:
  - 高優先度システム（UI、武器、ヘルス）のUniTask移行完了
  - メモリ使用量70%削減達成
  - 実行速度40%向上達成
  - 適切なエラーハンドリングとキャンセル制御

## 技術要件（Technical Requirements）

### TR-1: アーキテクチャ制約

#### TR-1.1 デザインパターン制約
- **要件ID**: TR-1.1
- **優先度**: 最高（Critical）
- **要件**: 特定デザインパターンの強制と禁止
- **詳細仕様**:
  - **必須パターン**: ServiceLocator（グローバルサービス管理）
  - **推奨パターン**: Command、ObjectPool、Observer（Event）、Strategy
  - **禁止パターン**: Singleton（ServiceLocatorで代替）
  - **制限パターン**: 静的クラスの最小化
- **受入条件**:
  - 新規実装でSingletonパターン使用ゼロ
  - ServiceLocatorによる全サービス管理
  - コードレビューでのパターン遵守確認

#### TR-1.2 依存性管理
- **要件ID**: TR-1.2
- **優先度**: 高（Must Have）
- **要件**: DIフレームワーク不使用での依存性管理
- **詳細仕様**:
  - ServiceLocatorによる依存性解決
  - コンストラクタインジェクション禁止
  - インターフェース経由のサービス取得
- **受入条件**:
  - Zenject、VContainer等のDIフレームワーク不使用
  - ServiceLocatorパターンの一貫した使用

### TR-2: 名前空間・コード規約

#### TR-2.1 名前空間階層
- **要件ID**: TR-2.1
- **優先度**: 高（Must Have）
- **要件**: 統一された名前空間階層の維持
- **詳細仕様**:
  - Root: `asterivo.Unity60`
  - Core機能: `asterivo.Unity60.Core.*`
  - 機能実装: `asterivo.Unity60.Features.*`
  - テスト: `asterivo.Unity60.Tests.*`
- **受入条件**:
  - 全新規コードが規約準拠
  - レガシーコード（`_Project.*`）の段階的移行

#### TR-2.2 コーディング標準
- **要件ID**: TR-2.2
- **優先度**: 高（Must Have）
- **要件**: 統一されたコーディング標準の遵守
- **詳細仕様**:
  - C# 9.0機能の積極活用（パターンマッチング、レコード型）
  - async/await（UniTask）優先
  - nullableリファレンス型の使用
  - readonly構造体の活用
- **受入条件**:
  - コード分析ツールによる自動チェック
  - プルリクエスト時の標準遵守確認

### TR-3: パフォーマンス技術要件

#### TR-3.1 メモリ管理
- **要件ID**: TR-3.1
- **優先度**: 最高（Critical）
- **要件**: 効率的なメモリ管理とGC最小化
- **詳細仕様**:
  - ObjectPool必須（コマンド、エフェクト、UI要素）
  - UniTaskによるゼロアロケーション非同期
  - 構造体優先（クラスより）
  - Spanの活用
- **受入条件**:
  - GC.Collect頻度50%削減
  - ヒープアロケーション70%削減
  - 60FPS安定維持

#### TR-3.2 最適化要件
- **要件ID**: TR-3.2
- **優先度**: 高（Must Have）
- **要件**: Unity固有の最適化実装
- **詳細仕様**:
  - LODグループ設定
  - オクルージョンカリング
  - ドローコールバッチング
  - テクスチャアトラス化
- **受入条件**:
  - ドローコール数50%削減
  - SetPassCall数40%削減
  - バッチング率80%以上

## 非機能要件（Non-Functional Requirements）

### NFR-1: パフォーマンス要件（UniTask統合後）

#### NFR-1.1 応答性
- **要件ID**: NFR-1.1
- **優先度**: 最高（Critical）
- **要件**: UniTask統合による応答性向上
- **詳細仕様**:
  - UI操作応答: 50ms以内（UniTask使用）
  - 入力遅延: 16ms以内（1フレーム）
  - アニメーション開始: 即座（DOTween Pro）
- **測定方法**: Unity Profiler、カスタムベンチマーク
- **受入条件**: 全UI操作が規定時間内応答

#### NFR-1.2 処理効率
- **要件ID**: NFR-1.2
- **優先度**: 高（Must Have）
- **要件**: CPU/GPU使用率の最適化
- **詳細仕様**:
  - メインスレッドCPU: 70%以下
  - GPU使用率: 80%以下
  - UniTaskによる非同期処理分散
- **測定方法**: Unity Profiler、RenderDoc
- **受入条件**: 全プラットフォームで基準値達成

### NFR-2: 開発効率要件

#### NFR-2.1 セットアップ時間
- **要件ID**: NFR-2.1
- **優先度**: 最高（Critical）
- **要件**: 1分以内の開発環境セットアップ
- **詳細仕様**:
  - git clone → プレイモード: 1分以内
  - 必要パッケージ自動インポート
  - 初期設定自動化
- **測定方法**: 実測タイム
- **受入条件**: 新規開発者の1分セットアップ達成

#### NFR-2.2 学習効率
- **要件ID**: NFR-2.2
- **優先度**: 高（Must Have）
- **要件**: 12時間以内の基本習得
- **詳細仕様**:
  - ドキュメント完備
  - サンプルコード提供
  - インタラクティブチュートリアル
- **測定方法**: 新規開発者フィードバック
- **受入条件**: 中級開発者の1週間習得達成

### NFR-3: 保守性要件

#### NFR-3.1 コード品質
- **要件ID**: NFR-3.1
- **優先度**: 高（Must Have）
- **要件**: 高品質コードベースの維持
- **詳細仕様**:
  - テストカバレッジ: 80%以上
  - 循環的複雑度: 10以下
  - Odin Validatorによる自動検証
- **測定方法**: SonarQube、Unity Test Runner
- **受入条件**: 全メトリクス基準達成

#### NFR-3.2 拡張性
- **要件ID**: NFR-3.2
- **優先度**: 高（Must Have）
- **要件**: 容易な機能追加と変更
- **詳細仕様**:
  - イベント駆動による疎結合
  - ScriptableObjectによるデータ駆動
  - UniTask統合による非同期拡張
- **測定方法**: 機能追加時間測定
- **受入条件**: 新機能追加が既存コード変更なしで可能

## 移行戦略と実装計画

### MS-1: UniTask移行戦略

#### MS-1.1 Phase 1: 即座移行対象（1-2週間）
- **対象**: UI通知システム、武器システム
- **優先度**: 最高（Critical）
- **移行内容**:
  - HUDManager通知システム
  - TPSWeaponManager装備・リロード処理
  - StealthUIManagerアニメーション
- **成功基準**:
  - メモリ使用量70%削減
  - 実行速度40%向上
  - 既存機能の完全互換性

#### MS-1.2 Phase 2: コア機能移行（1ヶ月）
- **対象**: ゲームプレイコア機能
- **優先度**: 高（Must Have）
- **移行内容**:
  - TPSPlayerHealthヘルス回復システム
  - GenreTemplateManagerジャンル遷移
  - AI状態制御システム
- **成功基準**:
  - 複雑な非同期処理の安定動作
  - 適切なキャンセル制御実装
  - エラーハンドリング統合

#### MS-1.3 Phase 3: 全体最適化（2-3ヶ月）
- **対象**: プロジェクト全体
- **優先度**: 中（Should Have）
- **移行内容**:
  - 残存コルーチンの完全移行
  - パフォーマンス最適化
  - ベストプラクティス確立
- **成功基準**:
  - コルーチン使用ゼロ達成
  - 開発ガイドライン策定
  - チーム全体のUniTask習熟

### MS-2: ServiceLocator移行戦略

#### MS-2.1 Singleton排除計画
- **対象**: 既存Singletonパターン使用箇所
- **優先度**: 最高（Critical）
- **実施内容**:
  - Singleton検出と文書化
  - ServiceLocator実装への置換
  - 依存関係の明確化
- **成功基準**:
  - Singletonパターン使用ゼロ
  - ServiceLocatorによる統一管理
  - テストカバレッジ80%以上

#### MS-2.2 サービス統合計画
- **対象**: 全グローバルサービス
- **優先度**: 高（Must Have）
- **実施内容**:
  - AudioManager統合
  - GameManager統合
  - InputManager統合
  - SaveManager統合
- **成功基準**:
  - 全サービスのServiceLocator登録
  - インターフェース経由アクセス
  - 循環依存ゼロ

## プロジェクト成功指標

### 定量的指標
| 指標 | 現在値 | 目標値 | 達成率 |
|------|--------|--------|--------|
| **セットアップ時間** | 30分 | 1分 | 97%短縮 |
| **学習コスト** | 40時間 | 12時間 | 70%削減 |
| **開発速度** | 基準値 | 150% | 50%向上 |
| **バグ発生率** | 基準値 | 40% | 60%削減 |
| **メモリ効率** | 基準値 | 5% | 95%削減 |
| **実行速度** | 基準値 | 167% | 67%向上 |

### 定性的指標
- **アーキテクチャ成熟度**: ServiceLocator + Event駆動の完全実装
- **コード品質**: デザインパターン遵守、テストカバレッジ80%
- **開発者体験**: Clone & Create価値の実現
- **保守性**: 新機能追加時の既存コード変更なし
- **拡張性**: 7ジャンルテンプレート対応

## リスクと制約

### 技術的リスク
| リスク | 影響度 | 発生確率 | 軽減策 |
|--------|--------|----------|--------|
| UniTask学習コスト | 高 | 中 | 段階的移行、チュートリアル提供 |
| ServiceLocator複雑化 | 中 | 低 | インターフェース設計、文書化 |
| パフォーマンス劣化 | 高 | 低 | プロファイリング、段階的最適化 |
| サードパーティ依存 | 中 | 中 | ライセンス管理、代替案準備 |

### 制約事項
- **Unity版本**: 6000.0.42f1固定（最新LTS）
- **Render Pipeline**: Universal Render Pipeline (URP)
- **Scripting Backend**: Mono
- **API Compatibility Level**: .NET Standard 2.1
- **DIフレームワーク**: 使用禁止（ServiceLocatorで代替）
- **Singletonパターン**: 使用禁止（ServiceLocatorで代替）
- **マルチプレイヤー**: 非対応（シングルプレイヤー専用）
- **優先プラットフォーム**: Windows（開発・テスト用）
- **対応プラットフォーム**: iOS, Android
- **非対応プラットフォーム**: Console（PlayStation, Xbox, Nintendo Switch）

## 次フェーズへの引き継ぎ

### DESIGN.md生成のための要件
1. **アーキテクチャ詳細設計**: ServiceLocator実装詳細
2. **UniTask統合設計**: 移行パターンと実装例
3. **データモデル設計**: ScriptableObject階層
4. **パフォーマンス設計**: ObjectPool、メモリ管理
5. **エディタツール設計**: Odin統合UI設計

### TASKS.md生成のための準備
1. **優先度付きタスクリスト**: Critical → Must Have → Should Have
2. **依存関係マトリクス**: タスク間の依存関係明確化
3. **工数見積もり**: 各タスクの実装時間
4. **成功条件定義**: 各タスクの完了条件
5. **検証方法**: テスト戦略と品質保証

---

**文書完了**: SPEC.md v3.2の全要件を形式化し、アーキテクチャとデザインパターンに完全準拠した要件定義書として更新完了。UniTask統合、ServiceLocatorパターン強制、サードパーティライブラリ要件を明確化。