# REQUIREMENTS.md - Unity 6 3Dゲーム基盤プロジェクト 形式化された要件定義

## 文書管理情報

- **ドキュメント種別**: 形式化された要件定義書
- **生成元**: SPEC.md - Unity 6 3Dゲーム基盤プロジェクト 初期構想・要件定義
- **対象読者**: 開発者、アーキテクト、プロジェクトマネージャー
- **更新日**: 2024年12月（SPEC.md v2.0 対応更新）

## プロジェクト識別情報

### プロジェクト定義
- **プロジェクトID**: URP3D_Base01
- **正式名称**: Unity 6ベース 3Dゲーム開発基盤テンプレート
- **プロジェクト分類**: ゲーム開発フレームワーク・テンプレート
- **開発手法**: スペック駆動開発（SDD）+ イベント駆動アーキテクチャ

### ステークホルダー要件マトリクス

| ステークホルダー | 優先度 | 主要要求事項 | 受益内容 |
|---|---|---|---|
| Unity開発者（中級～上級） | 最高 | モダンアーキテクチャ学習、実装品質向上 | 開発効率向上、コード品質改善 |
| ゲーム開発チーム | 最高 | 疎結合設計、協調開発支援 | チーム生産性向上、競合削減 |
| インディーゲーム開発者 | 高 | 高品質基盤、開発時間短縮 | 限定リソースでの効率的開発 |
| ゲームデザイナー | 中 | コード非依存バランス調整 | 独立したゲームデザイン作業 |
| サウンドデザイナー | 中 | 高品質3D空間オーディオ | リアルな音響体験創造 |

## 対象ゲームジャンル・最適化仕様

### 最適化対象ジャンル

#### ステルスアクションゲーム（最優先）
- **要件**: NPCの聴覚センサーシステムの完全実装
- **詳細**: 環境マスキング効果による音響制御、AI警戒レベル連動システム
- **成功基準**: リアルなステルスゲームプレイの実現

#### 3Dプラットフォーマー（高優先）
- **要件**: 物理ベースの移動システム
- **詳細**: カメラ状態管理（ThirdPerson, FirstPerson, Aim, Cover）、ジャンプ・落下・着地の状態管理
- **成功基準**: 流体的なプラットフォームアクションの実現

#### TPS/FPSゲーム（高優先）
- **要件**: Cinemachine 3.1統合カメラシステム
- **詳細**: コンバットシステム基盤、プレイヤー状態管理（戦闘、移動、インタラクション）
- **成功基準**: 競技性の高いシューティングゲームプレイの基盤提供

## 機能要件（Functional Requirements）

### FR-1: イベント駆動アーキテクチャシステム

#### FR-1.1 基本イベントシステム
- **要件ID**: FR-1.1
- **優先度**: 必須（Must Have）
- **要件**: ScriptableObjectベースのイベントチャネル実装
- **詳細仕様**:
  - `GameEvent`クラス: パラメータなし基本イベント
  - `GenericGameEvent<T>`クラス: 型パラメータ付きイベント
  - `PlayerStateEvent`, `CameraStateEvent`, `AudioEvent`: 専用イベント
- **受入条件**:
  - イベント発行（Raise）と購読（Listen）が正常動作する
  - 優先度付きリスナー管理が実装されている
  - 非同期イベント実行（RaiseAsync）が利用可能である
  - デバッグ機能（ログ出力、リスナー一覧表示）が動作する

#### FR-1.2 イベントリスナー管理
- **要件ID**: FR-1.2
- **優先度**: 必須（Must Have）
- **要件**: 高性能なイベントリスナー管理システム
- **詳細仕様**:
  - `HashSet<GameEventListener>`による高速リスナー管理
  - `IGameEventListener<T>`インターフェース実装
  - 優先度ソート済みリスナーリストのキャッシュ機能
- **受入条件**:
  - リスナー登録・解除が O(1) 時間で実行される
  - 優先度に基づく実行順序が保証される
  - メモリリークが発生しない

### FR-2: コマンドパターン+ObjectPool統合システム

#### FR-2.1 コマンド基盤システム
- **要件ID**: FR-2.1
- **優先度**: 必須（Must Have）
- **要件**: Factory+Registry+ObjectPool統合コマンド管理
- **詳細仕様**:
  - `ICommand`インターフェース（Execute, Undo, CanUndo）
  - `IResettableCommand`インターフェース（状態リセット）
  - `CommandPoolManager`クラス（統合管理）
  - `ITypeRegistry<IObjectPool<ICommand>>`による型安全管理
- **受入条件**:
  - コマンド実行・Undo機能が正常動作する
  - オブジェクトプールによるメモリ最適化が達成される
  - 統計情報（使用状況、再利用率）が取得できる

#### FR-2.2 具体的コマンド実装
- **要件ID**: FR-2.2
- **優先度**: 必須（Must Have）
- **要件**: ゲーム基本操作コマンドの実装
- **詳細仕様**:
  - `DamageCommand`: ダメージ処理とUndoの実装
  - `HealCommand`: 回復処理とUndoの実装
  - プレイヤー操作コマンド（移動、ジャンプ、クラウチ等）
- **受入条件**:
  - 各コマンドがUndoに対応している
  - コマンドプールによる再利用が機能している
  - コマンド実行統計が正確に記録される

### FR-3: ステートマシンシステム

#### FR-3.1 カメラステートマシン
- **要件ID**: FR-3.1
- **優先度**: 必須（Must Have）
- **要件**: 4状態対応カメラ制御システム
- **詳細仕様**:
  - `CameraStateMachine.cs`: 状態管理本体
  - **FirstPerson状態**: プレイヤー目線での一人称視点、精密操作対応、没入感重視
  - **ThirdPerson状態**: 後方視点での三人称視点、環境把握重視、標準ゲームプレイ
  - **Aim状態**: 照準・狙撃専用視点、FOV調整・手ブレ補正・照準UI表示
  - **Cover状態**: 遮蔽物利用時の専用視点、ピーキング動作・周囲警戒視野調整
  - `ICameraState`インターフェース実装各状態クラス
  - `Dictionary<CameraStateType, ICameraState>`による高速状態検索
- **受入条件**:
  - 各カメラ状態間の遷移が正常動作する
  - 各状態固有の視点特性が実装されている
  - Enter/Update/Exit ライフサイクルが適切に管理される
  - イベント駆動による状態変更通知が機能する

#### FR-3.2 AIステートマシン
- **要件ID**: FR-3.2
- **優先度**: 必須（Must Have）
- **要件**: 7状態対応AI行動制御システム
- **詳細仕様**:
  - `AIStateMachine.cs`: AI状態管理本体
  - **Idle状態**: 基本待機状態、軽微な監視、他状態への遷移待機
  - **Patrol状態**: 設定ルート巡回、NavMeshAgent自動移動、各地点での待機
  - **Suspicious状態**: 疑念状態、警戒レベル段階的上昇、注意深い監視
  - **Investigating状態**: 音響・異常調査、発生地点移動、証拠収集行動
  - **Searching状態**: 失ったターゲット捜索、組織的捜索、広範囲移動
  - **Alert状態**: 完全警戒状態、ターゲット追跡、情報伝達、接近試行
  - **Combat状態**: 実戦闘行動、直接攻撃、戦術的位置取り、ダメージ処理
  - NavMeshAgent統合による移動制御
  - 疑心レベル（Suspicion Level）による状態遷移制御（0.3で Suspicious、0.7で Alert）
- **受入条件**:
  - AI状態遷移が設計仕様通りに動作する
  - 各状態固有の行動パターンが実装されている
  - NavMeshAgentとの統合が正常に機能する
  - 疑心レベル変化による自動状態遷移が動作する

#### FR-3.3 プレイヤーステートマシン（実装予定）
- **要件ID**: FR-3.3
- **優先度**: 高（Should Have）
- **要件**: プレイヤー状態管理システムの完全実装
- **詳細仕様**:
  - `PlayerStateMachine.cs`: プレイヤー状態管理本体
  - 既存基盤クラス（BasePlayerState, IPlayerState）の活用
  - **基盤実装済み状態**:
    - **IdleState**: 基本待機状態、入力監視、待機アニメーション
    - **WalkingState**: 通常移動、標準速度制御、足音生成（ステルス連動）
    - **RunningState**: 高速移動、スタミナ消費、大きな足音（検知リスク増）
    - **CrouchingState**: しゃがみ姿勢、速度低下・コライダー縮小、検知リスク軽減
    - **ProneState**: 完全伏せ姿勢、移動速度大幅低下、最大隠蔽効果
    - **JumpingState**: 跳躍動作、重力適用・放物線軌道、着地検知
    - **RollingState**: 回避・ローリング動作
    - **CoverState**: 遮蔽物利用状態
  - **統合予定機能**:
    - Dictionary<PlayerStateType, IPlayerState>による高速状態管理
    - カメラシステム・オーディオシステムとの状態同期
    - 入力・物理・環境駆動の状態遷移制御
- **受入条件**:
  - プレイヤー状態遷移が正常動作する
  - 各状態の物理・音響特性が実装されている
  - アニメーション・物理演算との統合が機能する
  - 他システムとの状態連動が動作する

### FR-4: ステルス特化オーディオシステム

#### FR-4.1 中央制御システム
- **要件ID**: FR-4.1
- **優先度**: 必須（Must Have）
- **要件**: ステルスゲームプレイ統合音響管理
- **詳細仕様**:
  - `StealthAudioCoordinator`: Singletonによる中央制御
  - AIシステムとの警戒レベル連動
  - 環境マスキング効果の動的計算
  - リアルタイムオーディオダッキング（背景音減衰）
- **受入条件**:
  - AI警戒状態に応じた音響制御が動作する
  - 環境によるマスキング効果が正確に計算される
  - プレイヤー隠れ状態による音響抑制が機能する

#### FR-4.2 NPC聴覚センサーシステム
- **要件ID**: FR-4.2
- **優先度**: 必須（Must Have）
- **要件**: NPCの聴覚検知機能
- **詳細仕様**:
  - `NPCAuditorySensor`: NPC聴覚センサー実装
  - 3D空間での距離・方向による聴覚減衰
  - 音響マスキング効果の適用
  - プレイヤー音響イベントとの連動
- **受入条件**:
  - NPCがプレイヤーの音を適切に検知する
  - 環境音によるマスキング効果が機能する
  - 距離・障害物による聴覚減衰が正確である

### FR-5: Cinemachine 3.1統合カメラシステム

#### FR-5.1 Cinemachine統合
- **要件ID**: FR-5.1
- **優先度**: 必須（Must Have）
- **要件**: Cinemachine 3.1との統合カメラ制御
- **詳細仕様**:
  - `CinemachineIntegration`: Singleton統合管理クラス
  - `CameraConfig`設定による柔軟なカメラ構成
  - 複数VirtualCameraの優先度管理
  - イベント駆動カメラ状態変更システム
- **受入条件**:
  - Cinemachine VirtualCameraの切り替えが正常動作する
  - カメラブレンド設定が適用される
  - イベントによるカメラ制御が機能する

## 非機能要件（Non-Functional Requirements）

### FR-6: エディタ支援機能システム

#### FR-6.1 開発支援ツール
- **要件ID**: FR-6.1
- **優先度**: 高（Should Have）
- **要件**: 包括的な開発支援エディタツール
- **詳細仕様**:
  - `EventFlowVisualizer`: イベントフロー可視化、依存関係グラフ表示
  - `CommandInvokerEditor`: コマンド発行・Undo管理、履歴表示
  - `ProjectValidationWindow`: プロジェクト整合性検証、警告・エラー表示
  - `AudioSystemDebugger`: オーディオシステムデバッグ、リアルタイム監視
- **受入条件**:
  - 各ツールが Unity Editor 内で正常動作する
  - 開発効率向上に寄与する実用的な機能を提供する
  - 直感的で使いやすいUI/UXを実現する

#### FR-6.2 データ管理システム
- **要件ID**: FR-6.2
- **優先度**: 必須（Must Have）
- **要件**: ScriptableObjectベースのデータアセット管理
- **詳細仕様**:
  - キャラクターステータス、アイテムスペック、スキルデータの管理
  - ステルス検知設定、AI行動パラメータの調整機能
  - Inspector UI での直感的な編集環境
  - データバリデーション機能
- **受入条件**:
  - ノンプログラマーによるゲームバランス調整が可能
  - データ整合性が保たれる
  - 変更履歴の追跡が可能

## 非機能要件（Non-Functional Requirements）

### NFR-1: パフォーマンス要件

#### NFR-1.1 メモリ効率要件
- **要件ID**: NFR-1.1
- **優先度**: 必須（Must Have）
- **要件**: ObjectPool最適化によるメモリ効率化
- **測定基準**:
  - コマンドオブジェクトのメモリ使用量95%削減
  - ガベージコレクション頻度70%削減
- **測定方法**: Unity Profiler Memory使用量測定
- **受入条件**: ベンチマークテストでの目標値達成

#### NFR-1.2 実行効率要件
- **要件ID**: NFR-1.2
- **優先度**: 必須（Must Have）
- **要件**: コマンド実行・イベント処理の高速化
- **測定基準**:
  - コマンド実行速度67%改善
  - イベント処理レスポンス10ms以内
- **測定方法**: Unity Profiler CPU使用量測定
- **受入条件**: パフォーマンステストでの目標値達成

#### NFR-1.3 コンパイル時間要件
- **要件ID**: NFR-1.3
- **優先度**: 高（Should Have）
- **要件**: Assembly Definition活用による増分コンパイル最適化
- **測定基準**:
  - 増分コンパイル時間50%短縮
  - 初回フルコンパイル時間の安定化
- **測定方法**: Unity Editor コンパイル時間測定
- **受入条件**: 機能追加時のコンパイル時間が許容範囲内

### NFR-2: 品質要件

#### NFR-2.1 コード品質要件
- **要件ID**: NFR-2.1
- **優先度**: 必須（Must Have）
- **要件**: デザインパターンベストプラクティス準拠
- **測定基準**:
  - Cyclomatic Complexity 10以下
  - コードカバレッジ80%以上
- **測定方法**: 静的コード解析ツール使用
- **受入条件**: 品質メトリクスの達成

#### NFR-2.2 保守性要件
- **要件ID**: NFR-2.2
- **優先度**: 必須（Must Have）
- **要件**: 高保守性アーキテクチャの実現
- **測定基準**:
  - 疎結合度の定量的測定
  - 新機能追加時の既存コード変更箇所最小化
- **測定方法**: 依存関係分析、変更影響度分析
- **受入条件**: アーキテクチャ評価での高評価獲得

### NFR-3: 使用性要件

#### NFR-3.1 学習容易性要件
- **要件ID**: NFR-3.1
- **優先度**: 高（Should Have）
- **要件**: Unity中級開発者の学習支援
- **測定基準**:
  - 1週間での基本概念習得可能
  - 包括的ドキュメント・サンプル提供
- **測定方法**: ユーザビリティテスト実施
- **受入条件**: 学習効率目標の達成

#### NFR-3.2 ノンプログラマー対応要件
- **要件ID**: NFR-3.2
- **優先度**: 高（Should Have）
- **要件**: ScriptableObjectによるコード非依存設定
- **測定基準**:
  - ゲームバランス調整のコード編集不要
  - 直感的なInspector UI提供
- **測定方法**: ノンプログラマーによる操作テスト
- **受入条件**: コード非依存でのゲーム設定変更可能

## 技術要件・制約（Technical Requirements & Constraints）

### TR-1: 技術スタック要件

#### TR-1.1 必須技術環境
- **Unity Version**: 6000.0.42f1（最新LTS）
- **Render Pipeline**: Universal Render Pipeline (URP)
- **Scripting Backend**: Mono
- **API Compatibility Level**: .NET Standard 2.1
- **Build Target**: Windows (開発用), iOS, Android

#### TR-1.2 必須パッケージ
- `com.unity.render-pipelines.universal`: URP基盤
- `com.unity.inputsystem`: 新入力システム
- `com.unity.cinemachine`: カメラ制御
- `com.unity.ai.navigation`: AI ナビゲーション
- `com.unity.test-framework`: テストフレームワーク

#### TR-1.3 サードパーティ依存関係
- `UniTask`: 非同期プログラミング（推奨）
- `DOTween Pro`: 高度なアニメーション（有料）
- `Odin Inspector`: エディタ拡張（有料）
- `TextMeshPro`: テキストレンダリング

### TR-2: アーキテクチャ制約

#### TR-2.1 設計制約
- **DOTS/ECS**: 非対応（MonoBehaviour基盤）
- **マルチプレイヤー**: 非対応（シングルプレイヤー専用）
- **DI フレームワーク**: 現時点未使用（将来対応可能性あり）

#### TR-2.2 プラットフォーム制約
- **対応プラットフォーム**: Windows, iOS, Android
- **非対応プラットフォーム**: Console (PlayStation, Xbox, Nintendo Switch)
- **最小システム要件**: Unity 6 推奨システム要件準拠

## 検証・受入要件（Validation & Acceptance Criteria）

### VAR-1: 機能検証要件

#### VAR-1.1 システム統合テスト
- **テスト範囲**: 全コアシステムの統合動作
- **テスト項目**:
  - イベント駆動アーキテクチャの end-to-end テスト
  - コマンドシステムの実行・Undo テスト
  - ステートマシン遷移の網羅的テスト
  - オーディオシステムの統合テスト
- **成功基準**: 全テストケースの100%パス

#### VAR-1.2 パフォーマンステスト
- **テスト対象**: メモリ・CPU・コンパイル時間
- **測定環境**: 標準開発環境での定量測定
- **成功基準**: 全パフォーマンス要件の達成

### VAR-2: 品質保証要件

#### VAR-2.1 コード品質検証
- **静的解析**: コード品質メトリクス測定
- **コードレビュー**: アーキテクチャ遵守確認
- **成功基準**: 全品質基準の達成

#### VAR-2.2 文書化検証
- **対象文書**: アーキテクチャ・API・使用例ドキュメント
- **品質基準**: 網羅性・正確性・理解容易性
- **成功基準**: ドキュメント品質レビューでの承認

## スペック駆動開発（SDD）統合要件

### SDD-1: ワークフロー要件

#### SDD-1.1 フェーズ管理機能
- **要件**: 5段階フェーズの管理システム
- **詳細**: 
  1. **構想**（SPEC.md）: 高レベルビジョンの定義
  2. **形式化**（REQUIREMENTS.md）: 構造化された要件定義
  3. **設計**（DESIGN.md）: 技術的実装戦略
  4. **分解**（TASKS.md）: 実行可能なタスクリスト
  5. **実装・検証**: AIによるコード生成と品質保証
- **成功基準**: 各フェーズ間の整合性確保、トレーサビリティの維持

#### SDD-1.2 AI連携機能
- **要件**: Claude Code連携コマンドの実装
- **詳細**: 
  - `/spec-create`: SPEC.mdからREQUIREMENTS.mdを生成
  - `/design-create`: REQUIREMENTS.mdからDESIGN.mdを生成
  - `/tasks-create`: DESIGN.mdからTASKS.mdを生成
  - `/todo-execute`: TODO.mdの最高優先度タスクを実行
- **成功基準**: AIによる各フェーズ文書の自動生成、人間による品質検証

#### SDD-1.3 ドキュメント管理システム
- **要件**: マークダウンベースの段階的仕様書管理
- **詳細**:
  - **プロジェクトルート配置**: SPEC.md, REQUIREMENTS.md, DESIGN.md（基盤仕様書）
  - **作業ディレクトリ配置**: Assets/_Project/Docs/Work/ 内でTASKS.md, TODO.md管理
  - **作業ログ保管**: WorkLogs/ フォルダでの日時スナップショット管理
- **成功基準**: 一元的なドキュメント管理、バージョン追跡可能性

### SDD-2: 品質保証統合

#### SDD-2.1 MCPサーバー統合
- **要件**: unityMCP, context7, git等の戦略的活用
- **詳細**: 
  - **unityMCP**: ゲームエンジン内での直接操作、アセット管理、テスト実行
  - **context7**: 技術文書検索、API利用デバッグ、ハルシネーション防止
  - **git**: バージョン管理、ブランチ管理、変更履歴管理
  - **プロンプトエンジニアリング**: 各開発フェーズ特化テンプレート
- **成功基準**: AI+人間ハイブリッド開発の効率化、品質向上

## リスク管理要件

### RISK-1: 技術リスク

#### RISK-1.1 Unity 6安定性リスク
- **リスク内容**: 新バージョンによる予期せぬ問題
- **軽減策**: 定期的な安定版への移行
- **監視指標**: クラッシュ率、パフォーマンス劣化

#### RISK-1.2 サードパーティ依存リスク
- **リスク内容**: 有料アセットの利用不可・価格変動
- **軽減策**: 代替実装の準備・検討
- **監視指標**: ライセンス状況、代替実装コスト

### RISK-2: プロジェクトリスク

#### RISK-2.1 学習コストリスク
- **リスク内容**: 新アーキテクチャの学習負荷
- **軽減策**: 段階的導入・包括的ドキュメント作成
- **監視指標**: 開発者習得期間、満足度調査

## 成功指標・検証方法

### 定量的指標
- **メモリ効率**: ObjectPool使用時95%メモリ削減の達成
- **実行効率**: コマンド実行速度67%改善の達成
- **コンパイル時間**: Assembly Definition活用による増分コンパイル時間50%短縮
- **コード複雑度**: 各コンポーネントのCyclomatic Complexity 10以下を維持

### 定性的指標
- **開発者体験**: 新機能追加時の既存コードへの影響最小化
- **学習コスト**: Unity中級開発者が1週間で基本概念を習得可能
- **チーム協調性**: 複数人開発時の競合・依存関係によるブロッキング最小化
- **ノンプログラマー対応**: ゲームデザイナーがコードを触らずにバランス調整可能

### 検証方法
- **実装完了度**: 各システムの機能要件100%実装
- **ドキュメント充実度**: 全アーキテクチャパターンの解説・使用例完備
- **サンプルシーン**: 各システムの動作確認用シーンの実装
- **パフォーマンステスト**: Unity Profilerによる定量的性能測定

## 将来展望・拡張計画

### Phase 2 拡張計画
- **マルチプレイヤー対応**: Netcode for GameObjectsを活用した非同期マルチプレイヤー実装
- **Console対応**: PlayStation, Xbox, Nintendo Switch対応
- **DI フレームワーク導入**: VContainer等の軽量DIフレームワーク統合

### Phase 3 高度化計画
- **DOTS部分対応**: パフォーマンス重視箇所でのDOTS実装検討
- **クラウド連携**: Unity Cloud Build, Analytics統合
- **AI支援開発**: 機械学習によるゲームバランス自動調整システム

この要件定義書は、SPEC.mdで定義された構想を、実装可能な技術要件に変換し、後続のDESIGN.md生成の基盤となります。