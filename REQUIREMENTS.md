# REQUIREMENTS.md - Unity 6 3Dゲーム基盤プロジェクト 形式化された要件定義

## アーキテクチャとデザインパターン

### 最重要：3層アーキテクチャ (`Core` ← `Feature` ← `Template`)
- **アーキテクチャ基盤**: プロジェクト全体の関心事を3つの層に分離し、一方向の依存関係を徹底
- **Core層（ゲームのOS）**: ジャンルを問わない普遍的な「仕組み」を提供。イベントシステム、コマンドパターン、ServiceLocatorなど、プロジェクトの根幹をなすシステム
- **Feature層（ゲームのアプリケーション）**: Core層の仕組みを利用した具体的なゲーム機能の「部品」。プレイヤー移動、AIセンサー、武器システムなど、単体で機能するモジュール
- **Template層（ゲームのドキュメント）**: Feature層の部品を組み合わせた特定ゲームジャンルの「ひな形」。シーン、プレハブ、ScriptableObjectで構成され、ゲームデザイナーの作業領域

### コアパターン
- **ServiceLocator + Event駆動のハイブリッドアーキテクチャ（最重要）**: グローバルサービスへのアクセスとイベントベースの通信を組み合わせたハイブリッドアプローチ。Singletonパターンは使用禁止
- **イベント駆動型アーキテクチャ**: `GameEvent` を介したコンポーネント間の疎結合な連携
- **コマンドパターン**: ゲーム内のアクション（例：ダメージ、回復）をオブジェクトとしてカプセル化し、再利用と管理を容易にします
- **ObjectPool最適化**: 頻繁に作成・破棄されるコマンドオブジェクトをプール化し、メモリ効率とパフォーマンスを大幅に向上させます（95%のメモリ削減効果）
- **Scriptable Objectベースのデータ管理**: キャラクターのステータスやアイテム情報などをアセットとして管理
- **UniTask非同期パターン**: コルーチンからUniTaskへの段階的移行による、ゼロアロケーション非同期処理の実現

## 文書管理情報

- **ドキュメント種別**: 形式化された要件定義書（SDDフェーズ2: 形式化）
- **生成元**: SPEC.md - Unity 6 3Dゲーム基盤プロジェクト 初期構想・要件定義
- **トレーサビリティ**: SPEC.md の核心価値と実装方針を形式化し、後続 DESIGN.md 生成の基盤として機能
- **対象読者**: 開発者、アーキテクト、プロジェクトマネージャー
- **更新日**: 2025年9月20日（3層アーキテクチャ強調、サバイバルホラー要件詳細化）
- **整合性状態**: SPEC.md v3.3 との完全整合性確保済み（3層アーキテクチャ最重要化、サバイバルホラー特化機能追加）

## プロジェクト識別情報

### プロジェクト定義
- **プロジェクトID**: URP3D_Base01
- **正式名称**: **究極のUnity 6ベース 3Dゲーム開発基盤テンプレート**
- **プロジェクト分類**: ゲーム開発フレームワーク・テンプレート
- **開発手法**: スペック駆動開発（SDD）+ イベント駆動アーキテクチャ
- **アーキテクチャ基盤**: 3層アーキテクチャ（Core ← Feature ← Template）による完全な関心事分離
- **核心ビジョン**: 4つの核心価値の実現
  - **Clone & Create**: リポジトリクローンから1分でゲーム開発開始
  - **Learn & Grow**: 初心者から上級者まで段階的成長をサポート
  - **Ship & Scale**: プロトタイプからプロダクションまで完全対応
  - **Community & Ecosystem**: 活発なコミュニティとエコシステム形成（将来構想）

### ステークホルダー要件マトリクス

| ステークホルダー | 優先度 | 主要要求事項 | 受益内容 | 究極テンプレート要件 |
|---|---|---|---|---|
| Unity開発者（中級～上級） | 最高 | モダンアーキテクチャ学習、実装品質向上 | 開発効率150%向上、コード品質改善 | 学習コスト70%削減（12時間以内） |
| ゲーム開発チーム | 最高 | 疎結合設計、協調開発支援 | チーム生産性向上、競合削減 | セットアップ時閗1分以内、自動ビルド |
| インディーゲーム開発者 | 高 | 高品質基盤、開発時間短縮 | 限定リソースでの効率的開発 | 6ジャンルテンプレート、アセット統合ガイド |
| ゲームデザイナー | 中 | コード非依存バランス調整 | 独立したゲームデザイン作業 | ゲームプレイ設定、多言語対応 |
| サウンドデザイナー | 中 | 高品質3D空間オーディオ | リアルな音響体験創造 | 統合音響システム、AI連動 |

### 究極テンプレート成功指標

#### 定量的目標要件（SPEC.md v3.0 究極テンプレート完全対応）
- **セットアップ時間短縮**: 現在30分 → 目標1分（97%短縮）
- **学習コスト削減**: 現在40時間 → 目標12時間（70%削減）
- **開発速度向上**: 既存比150%向上
- **バグ発生率削減**: 60%削減
- **リリース準備時間短縮**: 80%短縮
- **メモリ効率維持**: ObjectPoolにより95%のメモリ削減効果維持
- **実行効率維持**: コマンド実行で67%の速度改善維持

#### 4つの核心価値実現要件（究極テンプレートビジョン）
- **Clone & Create**: リポジトリクローンから1分でゲーム開発開始、初心者でも迷わずセットアップ可能
- **Learn & Grow**: 初心者から上級者まで段階的成長をサポート、Unity中級開発者が1週間で基本概念習得可能
- **Ship & Scale**: プロトタイプからプロダクションまで完全対応、任意のゲームジャンルに即座対応

#### 定性的目標要件
- **Clone & Create**: 初心者でも迷わずセットアップ可能
- **Learn & Grow**: Unity中級開発者が1週間で基本概念習得可能
- **Ship & Scale**: 任意のゲームジャンルに即座対応

## 対象ゲームジャンル・最適化仕様

### 最適化対象ジャンル

#### ステルスアクションゲーム（最優先）
- **要件**: NPCのマルチモーダルAIセンサーシステムの完全実装（視覚、聴覚、嗅覚）。
- **詳細**: 環境マスキング効果による音響・嗅覚制御、AI警戒レベル連動システム。
- **成功基準**: リアルなステルスゲームプレイの実現。

#### サバイバルホラーゲーム（高優先）
- **要件**: プレイヤーの無力感と心理的圧迫を演出する包括的システムの統合
- **基本設計思想**: 脆弱な主人公、限定的な戦闘能力、リソースの希少性、永続的な脅威による持続的緊張感
- **視点システム**: 一人称/三人称視点切替による没入感の最大化（VRサポート含む）
- **核心システム**:
  - **リソース管理システム**: 弾薬・回復アイテムの欠乏感を演出する経済システム
  - **インベントリ制限**: 戦略的アイテム選択を強制する限定スロット
  - **ストーカー型AI**: 撃退可能だが倒せない、執拗に追跡する永続的脅威
  - **心理的恐怖システム**: 正気度（Sanity）管理、低下時の幻覚・操作デバフ
  - **雰囲気システム**: ダイナミック照明、環境音、天候による不安演出
- **ナラティブ要素**: 環境ストーリーテリング、ダイジェティックUI
- **進行ゲート**: アイテム・論理ベースのパズル
- **成功基準**: 持続的緊張感、カタルシスのあるサバイバル体験、プレイヤーの心理的没入

#### 3Dプラットフォーマー（高優先）
- **要件**: 応答性の高いCharacterControllerベースの移動システム。
- **詳細**: カメラ状態管理、ジャンプ・落下・着地の状態管理。
- **成功基準**: 流体的なプラットフォームアクションの実現。

#### TPS/FPSゲーム（高優先）
- **要件**: Cinemachine 3.1統合カメラシステムとコンバットシステム基盤。
- **詳細**: プレイヤー状態管理（戦闘、移動）、武器・弾薬管理。
- **成功基準**: 競技性の高いシューティングゲームプレイの基盤提供。

### 対応可能ジャンル

#### アクションRPG（中優先）
- **要件**: ScriptableObjectとコマンドパターンを活用した柔軟なRPGシステムの統合
- **基本設計思想**: リアルタイムアクションと戦略的成長システムの融合
- **核心システム**:
  - **キャラクタービルドシステム**: ScriptableObjectによるステータス・スキルツリー管理
  - **装備システム**: ランダム属性生成、セット効果、エンチャント機能
  - **戦略的戦闘**: コマンドパターンによるスキル・アクションの管理
  - **階層化AI**: 通常敵からボスまでの多様な行動パターン
  - **ダイナミックワールド**: イベント駆動による世界の変化
- **詳細要素**:
  - CharacterStats.asset: レベル、経験値、基礎ステータスのデータ管理
  - SkillTree.asset: スキル習得と成長パスの定義
  - ItemGenerator: ランダムプロパティ（マジック/レア/レジェンダリー）生成
  - CommandQueue: 戦闘アクションの順序管理とコンボシステム
  - QuestSystem: イベント駆動によるクエスト進行管理
  - Cinemachine統合: ボス戦演出、スキル発動カメラワーク
- **成功基準**: 
  - アクション性と成長要素のバランス実現
  - ノンプログラマーによるバランス調整可能
  - 10時間以上の継続プレイ価値提供

## 機能要件（Functional Requirements）

### FR-1: コアアーキテクチャシステム

#### FR-1.1 ServiceLocator + Event駆動ハイブリッドアーキテクチャ（最重要）
- **要件ID**: FR-1.1
- **優先度**: 最高（Critical） - **コアアーキテクチャの第1優先事項**
- **要件**: グローバルサービスへの統一アクセスとイベントベース通信の統合
- **詳細仕様**:
  - `ServiceLocator.cs`: 全グローバルサービス（オーディオ/ゲームマネージャー等）の登録・取得を管理
  - `IService`インターフェース: サービス基本契約
  - `GameEvent<T>`: 型安全なイベントチャネルとの連携
  - Singletonパターンの完全排除（ServiceLocatorで代替）
  - 依存性注入不要、可読性・保守性向上
- **実装効果**:
  - 関心事の分離・拡張性・再利用性・メンテナンス性向上
  - イベント駆動型と組み合わせた疎結合通信の実現
- **受入条件**:
  - 全サービスがServiceLocator経由でアクセス可能
  - イベント通信による疎結合実現
  - Singletonパターン使用箇所ゼロ
  - Core層でのServiceLocator積極活用

#### FR-1.2 イベント駆動アーキテクチャ
- **要件ID**: FR-1.2
- **優先度**: 最高（Critical）
- **要件**: ScriptableObjectベースのイベントシステム
- **詳細仕様**:
  - `GameEvent.cs`: イベント発行クラス
  - `GameEventListener.cs`: イベント購読コンポーネント
  - `EventChannelRegistry.cs`: イベント管理レジストリ
  - HashSet<T>によるO(1)パフォーマンス
- **受入条件**:
  - コンポーネント間の直接参照なし
  - イベントによる完全な疎結合通信
  - メモリリーク防止（WeakReference使用）

#### FR-1.3 コマンドパターン＋ObjectPool統合実装
- **要件ID**: FR-1.3
- **優先度**: 最高（Critical）
- **要件**: アクションのカプセル化と実行管理、ObjectPoolによる最適化統合
- **詳細仕様**:
  - `ICommand`インターフェース: Execute/Undo/CanUndo
  - `CommandInvoker.cs`: コマンド実行管理
  - `CommandHistory.cs`: 実行履歴管理
  - Factory+Registry+ObjectPool統合実装
  - DamageCommand, HealCommand等の再利用可能コマンドシステム
  - Undo/Redoサポート
- **期待効果**:
  - 95%メモリ削減効果
  - 67%実行速度改善
- **受入条件**:
  - 全ゲームアクションがコマンド化
  - Undo機能の完全実装
  - コマンド履歴の永続化対応
  - ObjectPoolによるメモリ最適化達成

#### FR-1.4 ObjectPool最適化システム
- **要件ID**: FR-1.4
- **優先度**: 最高（Critical）
- **要件**: メモリ効率とパフォーマンスの最大化
- **詳細仕様**:
  - `CommandPoolManager.cs`: コマンドオブジェクトプール管理
  - `IResettableCommand`: リセット可能コマンドインターフェース
  - 自動拡張・縮小機能
  - 統計・監視機能
- **受入条件**:
  - 95%のメモリ削減達成
  - 67%の実行速度改善達成
  - ゼロアロケーション実現

### FR-2: データ管理システム

#### FR-2.1 ScriptableObjectベースデータ管理
- **要件ID**: FR-2.1
- **優先度**: 高（Must Have）
- **要件**: データとロジックの完全分離
- **詳細仕様**:
  - `CharacterStats.asset`: キャラクターパラメータ
  - `WeaponData.asset`: 武器情報
  - `ItemData.asset`: アイテム定義
  - `GameSettings.asset`: ゲーム設定
- **受入条件**:
  - 全データがScriptableObject化
  - コード変更なしでバランス調整可能
  - Odin Inspectorによる編集UI最適化

#### FR-2.2 データ検証システム
- **要件ID**: FR-2.2
- **優先度**: 高（Must Have）
- **要件**: データ整合性の自動検証
- **詳細仕様**:
  - Odin Validatorによる自動検証
  - ビルド前チェック機能
  - カスタム検証ルール
  - エラーレポート生成
- **受入条件**:
  - ビルド時の自動検証実行
  - データ不整合の即座検出
  - 詳細なエラーレポート出力

### FR-3: 階層化ステートマシンシステム（HSM）

#### FR-3.1 階層化ステートマシン基盤
- **要件ID**: FR-3.1
- **優先度**: 高（Must Have）
- **配置**: `Assets/_Project/Core/Patterns/StateMachine`（Core層基盤）
- **要件**: Player、Camera、AIの複雑な状態管理を階層化により実現
- **詳細仕様**:
  - `HierarchicalStateMachine.cs`: 階層構造管理、状態の親子関係制御
    - ルート状態から葉状態までの階層的な状態管理
    - 親状態のロジック継承メカニズム
    - 子状態への自動遷移と委譲
  - `IState`インターフェース: 
    - `OnEnter()`: 状態進入時の初期化処理
    - `OnUpdate()`: 毎フレーム実行されるロジック（親から子へ順次実行）
    - `OnExit()`: 状態脱出時のクリーンアップ処理
    - `SubStates`: 子状態のコレクション管理
  - `StateFactory.cs`: 状態オブジェクトの生成と再利用管理
  - `StateTransition.cs`: 状態遷移条件とトリガー管理
- **イベント駆動統合**:
  - GameEventによる状態遷移トリガー
  - ServiceLocator経由でのStateManager中央管理
  - 状態変更通知のイベント発行
- **受入条件**:
  - ネスト状態の完全サポート（3階層以上）
  - 状態遷移のイベント駆動実現
  - 親状態ロジックの適切な継承
  - パフォーマンス最適化（状態切替1ms以内）

#### FR-3.2 プレイヤー状態管理
- **要件ID**: FR-3.2
- **優先度**: 高（Must Have）
- **要件**: プレイヤーキャラクターの状態制御
- **詳細仕様**:
  - 8状態: Idle/Walking/Running/Jumping/Falling/Attacking/Damaged/Dead
  - 状態遷移ルール定義
  - アニメーション連動
  - 入力制御統合
- **受入条件**:
  - 全状態の適切な遷移
  - アニメーションとの同期
  - 入力応答性の維持

#### FR-3.3 カメラ状態管理
- **要件ID**: FR-3.3
- **優先度**: 高（Must Have）
- **要件**: 動的カメラ制御システム
- **詳細仕様**:
  - 4状態: FirstPerson/ThirdPerson/Aim/Cover
  - Cinemachine 3.1統合
  - スムーズな状態遷移
  - プレイヤー状態連動
- **受入条件**:
  - カメラ切り替えの滑らか性
  - 状態間の適切な補間
  - 入力遅延なし

#### FR-3.4 AI状態管理
- **要件ID**: FR-3.4
- **優先度**: 高（Must Have）
- **要件**: NPC行動制御システム
- **詳細仕様**:
  - 7状態: Idle/Patrol/Suspicious/Investigating/Searching/Alert/Combat
  - NavMeshAgent統合
  - Behavior Tree連携
  - Memory System実装
- **受入条件**:
  - 自然なAI行動遷移
  - プレイヤー検知の適切性
  - パフォーマンス最適化

### FR-4: AIセンサーシステム

#### FR-4.1 視覚センサーシステム
- **要件ID**: FR-4.1
- **優先度**: 高（Must Have）
- **要件**: NPCの視覚検知機能
- **詳細仕様**:
  - `NPCVisualSensor.cs`: 視界スキャン実装
  - 視野角・距離パラメータ
  - 障害物判定（Raycast）
  - 4段階警戒レベル
- **受入条件**:
  - リアルな視覚検知
  - 10-20Hz更新頻度
  - 50体NPC同時稼働

#### FR-4.2 聴覚センサーシステム
- **要件ID**: FR-4.2
- **優先度**: 高（Must Have）
- **要件**: NPCの音響検知機能
- **詳細仕様**:
  - `NPCAuditorySensor.cs`: 3D音響検知
  - 距離減衰計算
  - 環境マスキング効果
  - 音源タイプ識別
- **受入条件**:
  - 物理的に正確な音響伝播
  - 環境音の影響考慮
  - リアルタイム処理

#### FR-4.3 嗅覚センサーシステム
- **要件ID**: FR-4.3
- **優先度**: 中（Should Have）
- **要件**: NPCの匂い検知機能
- **詳細仕様**:
  - `NPCOlfactorySensor.cs`: 嗅覚検知
  - `OdorSource.cs`: 匂い発生源
  - `WindSystem.cs`: 風向・風速管理
  - 匂いの伝播シミュレーション
- **受入条件**:
  - 風向による匂い拡散
  - 時間経過による減衰
  - 複数匂い源の処理

#### FR-4.4 センサー統合システム
- **要件ID**: FR-4.4
- **優先度**: 高（Must Have）
- **要件**: マルチモーダルセンサー統合
- **詳細仕様**:
  - `StealthSensorCoordinator.cs`: センサー統合管理
  - 重み付け優先度システム
  - 総合警戒レベル算出
  - AIStateMachine連携
- **受入条件**:
  - 全センサー情報の統合
  - 適切な優先度判定
  - リアルタイム応答性

### FR-5: オーディオシステム

#### FR-5.1 3D空間オーディオ
- **要件ID**: FR-5.1
- **優先度**: 高（Must Have）
- **要件**: リアルな3D音響体験
- **詳細仕様**:
  - `AudioManager.cs`: 中央音響管理
  - 3D空間定位
  - 距離減衰・ドップラー効果
  - 環境リバーブ
- **受入条件**:
  - 正確な音源定位
  - 自然な音響効果
  - パフォーマンス最適化

#### FR-5.2 動的音響環境
- **要件ID**: FR-5.2
- **優先度**: 中（Should Have）
- **要件**: 環境による音響変化
- **詳細仕様**:
  - `DynamicAudioEnvironment.cs`: 環境音響管理
  - オーディオゾーン定義
  - 材質による反響変化
  - 天候による音響効果
- **受入条件**:
  - リアルな環境音響
  - スムーズな遷移
  - メモリ効率性

### FR-6: プレイヤーシステム

#### FR-6.1 キャラクター移動制御
- **要件ID**: FR-6.1
- **優先度**: 最高（Critical）
- **要件**: 応答性の高い移動システム
- **詳細仕様**:
  - `PlayerController.cs`: 移動制御
  - CharacterController使用
  - 物理ベース移動
  - ジャンプ・ダッシュ機能
- **受入条件**:
  - 16ms以内の入力応答
  - 滑らかな移動制御
  - 物理的に自然な挙動

#### FR-6.2 インタラクションシステム
- **要件ID**: FR-6.2
- **優先度**: 高（Must Have）
- **要件**: オブジェクトとの相互作用
- **詳細仕様**:
  - `IInteractable`インターフェース
  - `Interactor.cs`: インタラクション管理
  - 範囲検知システム
  - UI表示連動
- **受入条件**:
  - 直感的な操作性
  - 明確なフィードバック
  - 拡張可能な設計

### FR-7: カメラシステム

#### FR-7.1 Cinemachine統合
- **要件ID**: FR-7.1
- **優先度**: 高（Must Have）
- **要件**: 高度なカメラ制御
- **詳細仕様**:
  - Cinemachine 3.1完全統合
  - VirtualCamera管理
  - ブレンド制御
  - ポストプロセシング連携
- **受入条件**:
  - プロ品質のカメラワーク
  - スムーズな遷移
  - 低遅延実現

#### FR-7.2 視点切り替えシステム
- **要件ID**: FR-7.2
- **優先度**: 高（Must Have）
- **要件**: 動的な視点変更
- **詳細仕様**:
  - 一人称/三人称切り替え
  - エイムモード対応
  - カバーカメラ実装
  - 状態保持機能
- **受入条件**:
  - 即座の視点切り替え
  - 違和感のない遷移
  - 状態の適切な管理

### FR-8: テンプレートシステム

#### FR-8.1 Interactive Setup Wizard
- **要件ID**: FR-8.1
- **優先度**: 最高（Critical）
- **要件**: 1分以内のセットアップ実現
- **詳細仕様**:
  - 環境診断機能
  - 自動設定最適化
  - パッケージ自動インポート
  - エラー自動修復
- **受入条件**:
  - git clone → Play: 1分以内
  - エラーゼロ起動
  - 初心者対応UI

#### FR-8.2 Game Genre Templates
- **要件ID**: FR-8.2
- **優先度**: 最高（Critical）
- **要件**: 7ジャンル対応テンプレート
- **対応ジャンル**:
  1. **Stealth Template**: ステルスアクション
  2. **Survival Horror Template**: サバイバルホラー
  3. **FPS Template**: 一人称シューティング
  4. **TPS Template**: 三人称シューティング
  5. **Platformer Template**: プラットフォーマー
  6. **Adventure Template**: アドベンチャー
  7. **Action RPG Template**: アクションRPG
- **受入条件**:
  - 各テンプレート15分プレイ可能
  - 完全動作サンプルシーン
  - カスタマイズ可能設計

#### FR-8.3 Learning System
- **要件ID**: FR-8.3
- **優先度**: 高（Must Have）
- **配置**: `Assets/_Project/Features/Tutorial`
- **要件**: 段階的学習サポートによる学習コスト70%削減の実現
- **詳細仕様**:
  - **5段階学習カリキュラム**:
    - Stage 1: 基礎概念（3層アーキテクチャ、ServiceLocator理解）
    - Stage 2: Core層活用（イベント、コマンド、ステートマシン）
    - Stage 3: Feature層実装（プレイヤー、AI、カメラ機能）
    - Stage 4: Template層カスタマイズ（ジャンル別設定）
    - Stage 5: プロダクション準備（最適化、デプロイ）
  - **インタラクティブチュートリアル**:
    - リアルタイムヒントシステム
    - 実践的なハンズオン課題
    - エラー時の自動ガイダンス
  - **学習支援コンテンツ**:
    - アーキテクチャ解説ドキュメント
    - パターン別サンプルコード
    - ベストプラクティスガイド
    - よくある質問と解決策
- **進捗管理システム**:
  - LearningProgressTracker.cs: 学習進捗の記録と分析
  - AchievementSystem: マイルストーン達成の可視化
  - SkillAssessment: 理解度テストと評価
- **受入条件**:
  - 12時間で基本概念習得（40時間→12時間、70%削減）
  - 進捗トラッキングの自動化
  - 理解度テスト80%以上合格率
  - Unity中級開発者1週間での実践投入

### FR-9: サバイバルホラー特化システム

#### FR-9.1 リソース欠乏管理システム
- **要件ID**: FR-9.1
- **優先度**: 高（Must Have）
- **配置**: `Assets/_Project/Features/Templates/SurvivalHorror/Systems`
- **要件**: 弾薬、回復アイテム、キーアイテムの希少性を管理し、プレイヤーに戦略的判断を強制するシステム
- **詳細仕様**:
  - `ResourceManager.cs`: シーン内の消費アイテムの総量を管理・監視するサービス（Core層ServiceLocator統合）
  - `InventoryComponent.cs`: 厳格なスロット制限（4-8スロット）を持つインベントリ
  - `ItemBoxComponent.cs`: インベントリ外のアイテムを保管するストレージ（セーフルーム配置）
  - `ItemCombinationSystem.cs`: アイテム組み合わせによる新アイテム生成（火薬＋弾丸ケース＝弾薬）
  - **リソースベースセーブ**: セーブに特定アイテム（インクリボン等）消費を要求する高難易度オプション
- **ScriptableObject定義**:
  - `ItemData.asset`: アイテム基本情報（名前、説明、アイコン、スタック可能数）
  - `CombinationRecipe.asset`: アイテム組み合わせレシピ
  - `ResourceBalanceConfig.asset`: 難易度別のリソース配置バランス設定
- **受入条件**:
  - アイテムの配置と消費のバランスがプレイヤーに常に緊張感を与える
  - インベントリ管理が探索と戦闘における重要な戦略的要素として機能
  - リソースベースセーブが高難易度モードで有効化可能
  - アイテム組み合わせシステムが直感的に操作可能

#### FR-9.2 雰囲気・心理的恐怖システム
- **要件ID**: FR-9.2
- **優先度**: 高（Must Have）
- **配置**: `Assets/_Project/Features/Templates/SurvivalHorror/Atmosphere`
- **要件**: 環境とプレイヤーの心理状態を動的に変化させ、持続的な不安と恐怖を演出するシステム
- **詳細仕様**:
  - `AtmosphereManager.cs`: 照明、フォグ、環境音、天候の統合管理（GameEvent連携）
    - 動的照明制御: 明暗の急激な変化、フリッカーライト、影の演出
    - 環境音響: 3D空間音響、不穏な環境音、突発的な効果音
    - 天候システム: 雨、霧、雷による視界・音響への影響
  - `SanitySystem.cs`: プレイヤーの正気度管理（0-100スケール）
    - 正気度トリガー: 暗闇滞在時間、敵との遭遇、グロテスク表現への暴露
    - 段階的効果: 
      - 80-100: 正常状態
      - 60-79: 軽度の幻聴、カメラの微細な揺れ
      - 40-59: 視覚歪み、偽の敵影、操作精度10%低下
      - 20-39: 幻覚敵出現、激しい画面効果、操作精度20%低下
      - 0-19: パニック状態、ランダム操作反転、敵検知範囲2倍
  - `HallucinationController.cs`: 正気度連動の幻覚演出制御
  - **ダイジェティックUI実装**:
    - 体力表示: 画面の血痕、視界のぼやけ、心拍音の強調
    - スタミナ表示: 息遣いの激しさ、足取りの重さ
    - 正気度表示: 手の震え、視界の歪み、内なる声
- **ScriptableObject定義**:
  - `SanityEventConfig.asset`: 正気度影響イベント定義
  - `HallucinationPreset.asset`: 幻覚演出パターン設定
  - `AtmospherePreset.asset`: シーン別雰囲気設定
- **受入条件**:
  - 環境演出が段階的にプレイヤーの不安を増幅させる
  - 正気度システムがゲームプレイに意味のある影響を与える
  - ダイジェティックUIが没入感を向上させる
  - 幻覚と現実の境界が曖昧になる演出の実現

#### FR-9.3 ストーカー型AIシステム
- **要件ID**: FR-9.3
- **優先度**: 高（Must Have）
- **配置**: `Assets/_Project/Features/Templates/SurvivalHorror/AI`
- **要件**: プレイヤーを永続的に追跡し、ゲームプレイに常に緊張感をもたらすストーカー型AI
- **詳細仕様**:
  - `StalkerAIController.cs`: 階層化ステートマシン（HSM）ベースの高度なAI制御
    - **基本状態**: Dormant（休眠）→ Hunting（探索）→ Stalking（追跡）→ Ambush（待ち伏せ）→ Attack（攻撃）
    - **センサー統合**: 視覚・聴覚・嗅覚センサーの融合による追跡（Core層AIセンサー活用）
    - **学習システム**: プレイヤーの行動パターンを記憶し、対策を講じる
  - **永続性メカニクス**:
    - 撃退可能だが復活: ダメージ蓄積で一時撤退、3-5分後に別位置から再出現
    - 不死属性: 特定の武器でのみ一時的無力化、完全撃破は不可能
    - テレポート能力: プレイヤーの視界外で高速移動、予期せぬ位置からの出現
  - **適応的行動パターン**:
    - 隠れ場所予測: プレイヤーがよく使う隠れ場所を記憶、先回り
    - ドア破壊: 一定時間後にバリケードされたドアを突破
    - 罠設置: プレイヤーの通路に待ち伏せ
    - 偽撤退: 追跡を諦めたふりをして油断を誘う
  - **心理的圧迫演出**:
    - 足音・呼吸音: 距離に応じた3D音響での存在感演出
    - 視線システム: プレイヤーを見つめる不気味な視線エフェクト
    - 正気度連動: 正気度50%以下で移動速度1.5倍、30%以下で壁通過能力獲得
- **データ定義**:
  - `StalkerBehaviorProfile.asset`: 難易度別AI行動パラメータ
  - `StalkerMemoryData`: プレイヤー行動記憶データ構造
  - `AmbushPointDatabase.asset`: マップ別待ち伏せポイント定義
- **受入条件**:
  - ストーカーAIが予測不能かつ恒常的な脅威として機能
  - 「完全な安全地帯は存在しない」という緊張感の維持
  - プレイヤーの行動に応じた多様な駆け引きの発生
  - 3-5分のリスポーンサイクルで緊張と緩和のリズム生成

(以降の非機能要件、技術要件などは変更なし)
...
(FR-8.1.2 Game Genre Templates System の項目を以下のように更新)

##### FR-8.1.2 Game Genre Templates System
- **要件ID**: FR-8.1.2
- **優先度**: 最高（Critical）
- **要件**: 7ジャンル対応テンプレートシステム
- **対応ジャンル**:
  1. **Stealth Template** - ステルスアクション
  2. **Survival Horror Template** - サバイバルホラー
  3. **FPS Template** - 一人称シューティング
  4. **TPS Template** - 三人称シューティング
  5. **Platformer Template** - プラットフォーマー
  6. **Adventure Template**: アドベンチャー
  7. **Action RPG Template**: アクションRPG

### FR-10: アクションRPGシステム要件

#### FR-10.1 キャラクター成長システム
- **要件ID**: FR-10.1
- **優先度**: 高（Must Have）
- **配置**: `Assets/_Project/Features/ActionRPG/Character`
- **要件**: ScriptableObjectベースの柔軟なキャラクタービルドシステム
- **詳細仕様**:
  - `CharacterStatsManager.cs`: レベル・経験値・ステータス管理
    - 基礎ステータス: STR, DEX, INT, VIT, AGI, LUK
    - 派生ステータス: ATK, DEF, MATK, MDEF, HP, MP, CritRate, CritDamage
    - レベルアップ式: 指数関数的経験値テーブル
  - `SkillTreeSystem.cs`: スキル習得と成長パス管理
    - ツリー構造によるスキル依存関係
    - スキルポイント配分システム
    - パッシブ/アクティブスキル分離
  - `TalentSystem.cs`: 特殊能力とビルドカスタマイズ
- **ScriptableObject定義**:
  - `CharacterClass.asset`: 職業別基礎パラメータ
  - `LevelTable.asset`: レベルアップ必要経験値
  - `SkillData.asset`: スキル詳細情報
- **受入条件**:
  - 多様なビルド構築可能性
  - バランス調整の容易性
  - セーブデータとの完全互換性

#### FR-10.2 装備・インベントリシステム
- **要件ID**: FR-10.2
- **優先度**: 高（Must Have）
- **配置**: `Assets/_Project/Features/ActionRPG/Inventory`
- **要件**: ランダム生成要素を含む装備システム
- **詳細仕様**:
  - `EquipmentSystem.cs`: 装備管理とステータス反映
    - 装備スロット: 武器、防具、アクセサリー（8スロット）
    - セット効果: 2/4/6個装備でのボーナス
    - エンチャントシステム: 追加効果付与
  - `ItemGenerator.cs`: ランダムプロパティ生成
    - レアリティ: Common/Magic/Rare/Legendary/Mythic
    - プレフィックス/サフィックスシステム
    - 数値範囲のランダム化
  - `InventoryManager.cs`: アイテム管理
    - グリッド式インベントリ（50スロット）
    - ソート・フィルター機能
    - スタック管理
- **受入条件**:
  - アイテム生成の多様性確保
  - UIとの完全統合
  - パフォーマンス最適化（1000アイテム管理）

#### FR-10.3 戦闘システム統合
- **要件ID**: FR-10.3
- **優先度**: 高（Must Have）
- **配置**: `Assets/_Project/Features/ActionRPG/Combat`
- **要件**: コマンドパターンとObjectPoolを活用した戦闘システム
- **詳細仕様**:
  - `CombatManager.cs`: 戦闘フロー管理
    - ダメージ計算式: (ATK * SkillRatio - DEF) * RandomRange(0.9f, 1.1f)
    - クリティカル判定とダメージ倍率
    - 属性相性システム（火/水/風/土/光/闇）
  - `SkillCommandQueue.cs`: スキル実行管理
    - コマンドパターンによるスキル実装
    - ObjectPoolによるエフェクト最適化
    - クールダウン管理
  - `ComboSystem.cs`: 連続技システム
    - タイミング判定によるコンボ継続
    - コンボ倍率とフィニッシャー
- **受入条件**:
  - 60FPSでの安定動作
  - 100体同時戦闘対応
  - スキルエフェクトの美麗表現

### FR-11: サードパーティライブラリ統合要件

#### FR-11.1 DOTween Pro統合
- **要件ID**: FR-11.1
- **優先度**: 高（Must Have）
- **要件**: DOTween Proによる高品質アニメーションシステムの統合
- **詳細仕様**:
  - UIアニメーション、カメラ遷移、エフェクトアニメーションへの統合
  - UniTaskとの連携による非同期アニメーション制御
  - パフォーマンス最適化（プーリング、キャッシング）
- **受入条件**:
  - 全UIアニメーションがDOTween Pro経由で実行される
  - UniTaskとのシームレスな統合（`.ToUniTask()`メソッド）
  - メモリリーク防止（適切なKill処理）

#### FR-11.2 Odin Inspector/Validator/Serializer統合
- **要件ID**: FR-11.2
- **優先度**: 高（Must Have）
- **要件**: Odinスイートによる開発効率とデータ整合性の向上
- **詳細仕様**:
  - **Odin Inspector**: カスタムインスペクターUI、ScriptableObject編集強化
  - **Odin Validator**: プロジェクト整合性の自動検証、ビルド前チェック
  - **Odin Serializer**: 複雑なデータ構造のシリアライゼーション
- **受入条件**:
  - 全ScriptableObjectがOdin Inspectorで最適化されたUI表示
  - ビルド前の自動検証によるエラー防止
  - 複雑なネスト構造のデータ保存・読み込み対応

#### FR-11.3 UniTask非同期処理統合
- **要件ID**: FR-11.3
- **優先度**: 最高（Critical）
- **要件**: コルーチンからUniTaskへの段階的移行と完全統合
- **詳細仕様**:
  - 新規実装は全てUniTask使用必須
  - 既存コルーチンの段階的移行計画
  - CancellationToken統一管理システム
  - DOTweenとの統合（`Tween.ToUniTask()`）
- **受入条件**:
  - 高優先度システム（UI、武器、ヘルス）のUniTask移行完了
  - メモリ使用量70%削減達成
  - 実行速度40%向上達成
  - 適切なエラーハンドリングとキャンセル制御

## 技術要件（Technical Requirements）

### TR-1: 3層アーキテクチャ制約

#### TR-1.1 層間依存関係制約
- **要件ID**: TR-1.1
- **優先度**: 最高（Critical）
- **要件**: 3層アーキテクチャの一方向依存関係の厳格な維持
- **詳細仕様**:
  - **依存方向**: Template層 → Feature層 → Core層（逆方向参照は完全禁止）
  - **Core層制約**: 
    - Feature層・Template層への直接参照禁止
    - GameEventによるイベント駆動通信のみ許可
    - ServiceLocatorによるサービス登録・提供
  - **Feature層制約**:
    - Core層の機能を活用した具体実装
    - Template層への直接参照禁止
    - 他Feature間はGameEvent経由での通信
  - **Template層制約**:
    - Feature層の機能を組み合わせた実装
    - ScriptableObjectによる設定・データ定義中心
    - ロジック実装は最小限に留める
- **Assembly Definition強制**:
  - Core.asmdef: Core層のアセンブリ定義
  - Features.asmdef: Feature層のアセンブリ定義  
  - Templates.asmdef: Template層のアセンブリ定義
  - 依存関係違反時のコンパイルエラー化
- **受入条件**:
  - 層間の逆方向参照ゼロ
  - Assembly Definition による依存関係強制
  - 自動テストによる依存関係検証

#### TR-1.2 デザインパターン制約
- **要件ID**: TR-1.2  
- **優先度**: 最高（Critical）
- **要件**: 特定デザインパターンの強制と禁止
- **詳細仕様**:
  - **必須パターン**: 
    - ServiceLocator（Core層でのグローバルサービス管理）
    - Event-Driven（層間通信の基盤）
    - Command + ObjectPool（アクション管理と最適化）
  - **推奨パターン**: HSM、Strategy、Factory、Registry
  - **禁止パターン**: 
    - Singleton（ServiceLocatorで完全代替）
    - God Object（責務の適切な分離）
  - **制限パターン**: 静的クラスの最小化（テストability確保）
- **受入条件**:
  - 新規実装でSingletonパターン使用ゼロ
  - ServiceLocatorによる全サービス管理
  - コードレビューでのパターン遵守確認

#### TR-1.3 依存性管理戦略
- **要件ID**: TR-1.3
- **優先度**: 高（Must Have）
- **要件**: DIフレームワーク不使用での明確な依存性管理
- **詳細仕様**:
  - **ServiceLocatorによる依存性解決**:
    - Core層でのServiceLocator実装
    - IServiceインターフェース経由のサービス取得
    - 起動時の一括サービス登録（GameBootstrapper）
  - **禁止事項**:
    - コンストラクタインジェクション
    - Zenject、VContainer等のDIフレームワーク
    - 循環依存の発生
  - **推奨事項**:
    - インターフェース分離原則の遵守
    - サービスの責務明確化
    - テスト時のモックサービス登録対応
- **受入条件**:
  - DIフレームワーク完全不使用
  - ServiceLocatorパターンの一貫した使用
  - 循環依存ゼロの達成

### TR-2: 名前空間・コード規約

#### TR-2.1 名前空間階層
- **要件ID**: TR-2.1
- **優先度**: 高（Must Have）
- **要件**: 統一された名前空間階層の維持
- **詳細仕様**:
  - Root: `asterivo.Unity60`
  - Core機能: `asterivo.Unity60.Core.*`
  - 機能実装: `asterivo.Unity60.Features.*`
  - テスト: `asterivo.Unity60.Tests.*`
- **受入条件**:
  - 全新規コードが規約準拠
  - レガシーコード（`_Project.*`）の段階的移行

#### TR-2.2 コーディング標準
- **要件ID**: TR-2.2
- **優先度**: 高（Must Have）
- **要件**: 統一されたコーディング標準の遵守
- **詳細仕様**:
  - C# 9.0機能の積極活用（パターンマッチング、レコード型）
  - async/await（UniTask）優先
  - nullableリファレンス型の使用
  - readonly構造体の活用
- **受入条件**:
  - コード分析ツールによる自動チェック
  - プルリクエスト時の標準遵守確認

### TR-3: パフォーマンス技術要件

#### TR-3.1 メモリ管理
- **要件ID**: TR-3.1
- **優先度**: 最高（Critical）
- **要件**: 効率的なメモリ管理とGC最小化
- **詳細仕様**:
  - ObjectPool必須（コマンド、エフェクト、UI要素）
  - UniTaskによるゼロアロケーション非同期
  - 構造体優先（クラスより）
  - Spanの活用
- **受入条件**:
  - GC.Collect頻度50%削減
  - ヒープアロケーション70%削減
  - 60FPS安定維持

#### TR-3.2 最適化要件
- **要件ID**: TR-3.2
- **優先度**: 高（Must Have）
- **要件**: Unity固有の最適化実装
- **詳細仕様**:
  - LODグループ設定
  - オクルージョンカリング
  - ドローコールバッチング
  - テクスチャアトラス化
- **受入条件**:
  - ドローコール数50%削減
  - SetPassCall数40%削減
  - バッチング率80%以上

## 非機能要件（Non-Functional Requirements）

### NFR-1: パフォーマンス要件

#### NFR-1.1 応答性
- **要件ID**: NFR-1.1
- **優先度**: 最高（Critical）
- **要件**: 3層アーキテクチャによる高応答性の実現
- **詳細仕様**:
  - UI操作応答: 50ms以内（UniTask使用）
  - 入力遅延: 16ms以内（1フレーム）
  - アニメーション開始: 即座（DOTween Pro）
  - 状態遷移: 1ms以内（HSM最適化）
  - イベント伝播: 0.5ms以内（GameEvent最適化）
- **測定方法**: Unity Profiler、カスタムベンチマーク
- **受入条件**: 
  - 全UI操作が規定時間内応答
  - 60FPS安定維持（16.67ms/frame）
  - GC.Allocゼロフレームの実現

#### NFR-1.2 処理効率
- **要件ID**: NFR-1.2
- **優先度**: 高（Must Have）
- **要件**: CPU/GPU使用率の最適化
- **詳細仕様**:
  - メインスレッドCPU: 70%以下
  - GPU使用率: 80%以下
  - UniTaskによる非同期処理分散
- **測定方法**: Unity Profiler、RenderDoc
- **受入条件**: 全プラットフォームで基準値達成

### NFR-2: 開発効率要件

#### NFR-2.1 セットアップ時間
- **要件ID**: NFR-2.1
- **優先度**: 最高（Critical）
- **要件**: 1分以内の開発環境セットアップ
- **詳細仕様**:
  - git clone → プレイモード: 1分以内
  - 必要パッケージ自動インポート
  - 初期設定自動化
- **測定方法**: 実測タイム
- **受入条件**: 新規開発者の1分セットアップ達成

#### NFR-2.2 学習効率
- **要件ID**: NFR-2.2
- **優先度**: 高（Must Have）
- **要件**: 12時間以内の基本習得
- **詳細仕様**:
  - ドキュメント完備
  - サンプルコード提供
  - インタラクティブチュートリアル
- **測定方法**: 新規開発者フィードバック
- **受入条件**: 中級開発者の1週間習得達成

### NFR-3: 保守性要件

#### NFR-3.1 コード品質
- **要件ID**: NFR-3.1
- **優先度**: 高（Must Have）
- **要件**: 高品質コードベースの維持
- **詳細仕様**:
  - テストカバレッジ: 80%以上
  - 循環的複雑度: 10以下
  - Odin Validatorによる自動検証
- **測定方法**: SonarQube、Unity Test Runner
- **受入条件**: 全メトリクス基準達成

#### NFR-3.2 拡張性
- **要件ID**: NFR-3.2
- **優先度**: 高（Must Have）
- **要件**: 容易な機能追加と変更
- **詳細仕様**:
  - イベント駆動による疎結合
  - ScriptableObjectによるデータ駆動
  - UniTask統合による非同期拡張
- **測定方法**: 機能追加時間測定
- **受入条件**: 新機能追加が既存コード変更なしで可能

## 移行戦略と実装計画

### MS-1: UniTask移行戦略

#### MS-1.1 Phase 1: 即座移行対象（1-2週間）
- **対象**: UI通知システム、武器システム
- **優先度**: 最高（Critical）
- **移行内容**:
  - HUDManager通知システム
  - TPSWeaponManager装備・リロード処理
  - StealthUIManagerアニメーション
- **成功基準**:
  - メモリ使用量70%削減
  - 実行速度40%向上
  - 既存機能の完全互換性

#### MS-1.2 Phase 2: コア機能移行（1ヶ月）
- **対象**: ゲームプレイコア機能
- **優先度**: 高（Must Have）
- **移行内容**:
  - TPSPlayerHealthヘルス回復システム
  - GenreTemplateManagerジャンル遷移
  - AI状態制御システム
- **成功基準**:
  - 複雑な非同期処理の安定動作
  - 適切なキャンセル制御実装
  - エラーハンドリング統合

#### MS-1.3 Phase 3: 全体最適化（2-3ヶ月）
- **対象**: プロジェクト全体
- **優先度**: 中（Should Have）
- **移行内容**:
  - 残存コルーチンの完全移行
  - パフォーマンス最適化
  - ベストプラクティス確立
- **成功基準**:
  - コルーチン使用ゼロ達成
  - 開発ガイドライン策定
  - チーム全体のUniTask習熟

### MS-2: ServiceLocator移行戦略

#### MS-2.1 Singleton排除計画
- **対象**: 既存Singletonパターン使用箇所
- **優先度**: 最高（Critical）
- **実施内容**:
  - Singleton検出と文書化
  - ServiceLocator実装への置換
  - 依存関係の明確化
- **成功基準**:
  - Singletonパターン使用ゼロ
  - ServiceLocatorによる統一管理
  - テストカバレッジ80%以上

#### MS-2.2 サービス統合計画
- **対象**: 全グローバルサービス
- **優先度**: 高（Must Have）
- **実施内容**:
  - AudioManager統合
  - GameManager統合
  - InputManager統合
  - SaveManager統合
- **成功基準**:
  - 全サービスのServiceLocator登録
  - インターフェース経由アクセス
  - 循環依存ゼロ

## プロジェクト成功指標

### 定量的指標
| 指標 | 現在値 | 目標値 | 達成率 |
|------|--------|--------|--------|
| **セットアップ時間** | 30分 | 1分 | 97%短縮 |
| **学習コスト** | 40時間 | 12時間 | 70%削減 |
| **開発速度** | 基準値 | 150% | 50%向上 |
| **バグ発生率** | 基準値 | 40% | 60%削減 |
| **メモリ効率** | 基準値 | 5% | 95%削減 |
| **実行速度** | 基準値 | 167% | 67%向上 |

### 定性的指標
- **アーキテクチャ成熟度**: ServiceLocator + Event駆動の完全実装
- **コード品質**: デザインパターン遵守、テストカバレッジ80%
- **開発者体験**: Clone & Create価値の実現
- **保守性**: 新機能追加時の既存コード変更なし
- **拡張性**: 7ジャンルテンプレート対応

## リスクと制約

### 技術的リスク
| リスク | 影響度 | 発生確率 | 軽減策 |
|--------|--------|----------|--------|
| UniTask学習コスト | 高 | 中 | 段階的移行、チュートリアル提供 |
| ServiceLocator複雑化 | 中 | 低 | インターフェース設計、文書化 |
| パフォーマンス劣化 | 高 | 低 | プロファイリング、段階的最適化 |
| サードパーティ依存 | 中 | 中 | ライセンス管理、代替案準備 |

### 制約事項
- **Unity版本**: 6000.0.42f1固定（最新LTS）
- **Render Pipeline**: Universal Render Pipeline (URP)
- **Scripting Backend**: Mono
- **API Compatibility Level**: .NET Standard 2.1
- **アーキテクチャ制約**:
  - **3層アーキテクチャ**: Core ← Feature ← Template の厳格な遵守
  - **DIフレームワーク**: 使用禁止（ServiceLocatorで代替）
  - **Singletonパターン**: 使用禁止（ServiceLocatorで代替）
  - **層間通信**: GameEvent経由のイベント駆動通信のみ
  - **Assembly Definition**: 各層でのasmdef必須定義
- **マルチプレイヤー**: 非対応（シングルプレイヤー専用）
- **優先プラットフォーム**: Windows（開発・テスト用）
- **対応プラットフォーム**: iOS, Android
- **非対応プラットフォーム**: Console（PlayStation, Xbox, Nintendo Switch）

## 次フェーズへの引き継ぎ

### DESIGN.md生成のための要件
1. **アーキテクチャ詳細設計**: ServiceLocator実装詳細
2. **UniTask統合設計**: 移行パターンと実装例
3. **データモデル設計**: ScriptableObject階層
4. **パフォーマンス設計**: ObjectPool、メモリ管理
5. **エディタツール設計**: Odin統合UI設計

### TASKS.md生成のための準備
1. **優先度付きタスクリスト**: Critical → Must Have → Should Have
2. **依存関係マトリクス**: タスク間の依存関係明確化
3. **工数見積もり**: 各タスクの実装時間
4. **成功条件定義**: 各タスクの完了条件
5. **検証方法**: テスト戦略と品質保証

---

**文書完了**: SPEC.md v3.3の全要件を形式化し、3層アーキテクチャ（Core ← Feature ← Template）を最重要事項として明確化。サバイバルホラー特化システム（FR-9）、アクションRPGシステム（FR-10）の詳細要件を追加。階層化ステートマシン（HSM）、学習システムの具体的実装要件を定義。究極テンプレート成功指標（セットアップ時間97%短縮、学習コスト70%削減）の達成基準を明確化。